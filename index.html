<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- –°–º—è–≥—á—ë–Ω–Ω—ã–π CSP –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ file:// -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' blob: data: file:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' data: blob: file:; frame-src 'none'">
  <title>FinBoard</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="assets/prefs.js"></script>
  <script src="assets/help.js"></script>
  <script src="assets/xml.js"></script>
  <script src="assets/charts.js"></script>
  <script src="assets/app.js"></script>
</head>
<body>
<div class="app">
  <header>
    <nav class="top-nav">
      <a href="index.html" class="active" title="FinBoard">FinBoard</a>
      <a href="gross-net.html" title="Gross/Net">Gross/Net</a>
    </nav>
    <div class="spacer"></div>
    <h1>FinBoard</h1>
    <div class="spacer"></div>
    <div class="pill" id="currencySwitcher" title="–í–∞–ª—é—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è">
      <label class="muted" for="selCurrency" style="margin:0">–í–∞–ª—é—Ç–∞:</label>
      <select id="selCurrency">
        <option value="BGN">BGN</option>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
      </select>
    </div>
    
    <div id="themeToggle" class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span class="theme-icon">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </div>
    <div id="helpToggle" class="help-toggle" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É">
      <span class="help-icon">‚ùì</span>
    </div>
    <div class="pill" id="demoWrap" style="margin-left:8px;display:flex;align-items:center;gap:6px">
      <button id="btnDemo" class="icon-btn" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ">‚ñ∂</button>
      <span id="demoLabel" class="muted" style="user-select:none">–î–µ–º–æ</span>
    </div>
    <button id="btnClearStorage" class="icon-btn" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" style="margin-left:8px">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
    </button>
    <div id="settingsToggle" class="settings-toggle" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"><span class="settings-icon">‚öôÔ∏è</span></div>
    <button id="btnLock" class="btn" style="display:none">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
  </header>

  <aside class="side" id="side"></aside>
  <main class="content" id="main"></main>
</div>

<!-- demo data moved to external file for cleanliness -->
<script src="demo/demo-data.js"></script>

<script>
// ===== –£–¢–ò–õ–ò–¢–´ =====
const $ = (sel,root=document)=>root.querySelector(sel)
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel))
const fmt = new Intl.NumberFormat('ru-RU',{style:'currency',currency:'BGN',maximumFractionDigits:2})
const monthFmt = new Intl.DateTimeFormat('ru-RU',{year:'numeric',month:'2-digit'})
const dateFmt = new Intl.DateTimeFormat('ru-RU')
// Currency conversion helpers (display currency from PREFS, BGN as hub)
function prefsFx(){ try{ return (window.PREFS && PREFS.getFx && PREFS.getFx()) }catch(_){ } try{ return (window.PREFS && PREFS.getFxDefaults && PREFS.getFxDefaults()) }catch(_){ } return { BGN_EUR: 1.95583, BGN_USD: 1.65230 } }
function getDisplayCurrency(){ try{ return (window.PREFS && PREFS.get && (PREFS.get().preferredCurrency||null)) || STATE?.vault?.currency || 'BGN' }catch(_){ return (STATE?.vault?.currency)||'BGN' } }
function convertValue(amount){
  const from = (STATE?.vault?.currency)||'BGN'
  const to = getDisplayCurrency()
  if(!Number.isFinite(amount)) amount = 0
  if(from===to) return amount
  const fx = prefsFx()
  // to BGN
  let inBGN = amount
  if(from==='EUR') inBGN = amount * fx.BGN_EUR
  else if(from==='USD') inBGN = amount * fx.BGN_USD
  // from BGN to target
  if(to==='BGN') return inBGN
  if(to==='EUR') return inBGN / fx.BGN_EUR
  if(to==='USD') return inBGN / fx.BGN_USD
  return amount
}
function formatAmountDisplay(amount){
  const cur = getDisplayCurrency()
  return new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur}).format(convertValue(amount))
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô =====
function initTheme() {
  try{ if(window.PREFS && PREFS.initThemeFromPrefs){ PREFS.initThemeFromPrefs(); return } }catch(_){ }
  const savedTheme = localStorage.getItem('finboard_theme') || 'dark'
  document.documentElement.setAttribute('data-theme', savedTheme)
}

function toggleTheme() {
  try{ if(window.PREFS && PREFS.toggleThemeByPrefs){ PREFS.toggleThemeByPrefs(); return } }catch(_){ }
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark'
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
  document.documentElement.setAttribute('data-theme', newTheme)
  localStorage.setItem('finboard_theme', newTheme)
  toast(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${newTheme === 'dark' ? '—Ç–µ–º–Ω—É—é' : '—Å–≤–µ—Ç–ª—É—é'} —Ç–µ–º—É`)
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ü–†–ê–í–ö–û–ô =====
let HELP_VISIBLE = false

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–ï–ô –û–ü–ï–†–ê–¶–ò–ô =====
let RECENT_LIMIT = 8
let SEARCH_TEXT = ''
let CAT_FILTER = 'all'

function getFilteredAndSearchedTransactions() {
  let filtered = filteredTransactions()
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)
  if (CAT_FILTER && CAT_FILTER !== 'all') {
    filtered = filtered.filter(t => {
      const cat = t.category || ''
      if (CAT_FILTER === '__none__') return !cat
      return cat === CAT_FILTER
    })
  }

  if (SEARCH_TEXT.trim()) {
    const searchLower = SEARCH_TEXT.toLowerCase()
    filtered = filtered.filter(t => {
      const desc = (t.desc || '').toLowerCase()
      const category = (t.category || '').toLowerCase()
      return desc.includes(searchLower) || category.includes(searchLower)
    })
  }
  
  return filtered.sort((a,b) => new Date(b.date) - new Date(a.date))
}

function toggleHelp() {
  HELP_VISIBLE = !HELP_VISIBLE
  const helpToggle = $('#helpToggle')
  const helpBlock = $('#helpBlock')
  
  if(helpToggle) {
    helpToggle.classList.toggle('active', HELP_VISIBLE)
    helpToggle.title = HELP_VISIBLE ? '–°–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É' : '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É'
  }
  
  if(helpBlock) {
    helpBlock.style.display = HELP_VISIBLE ? 'block' : 'none'
  }
  
  toast(HELP_VISIBLE ? '–°–ø—Ä–∞–≤–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞' : '–°–ø—Ä–∞–≤–∫–∞ —Å–∫—Ä—ã—Ç–∞')
}

const b64 = {
  enc: arr => btoa(String.fromCharCode(...arr)),
  dec: str => new Uint8Array(atob(str).split('').map(c=>c.charCodeAt(0)))
}

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function monthKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}

// ===== –î–ê–¢–´/–ü–ï–†–ò–û–î–´ =====
function formatISODate(d){
  // –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ YYYY-MM-DD, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–º–µ—â–µ–Ω–∏—è –ø–æ TZ
  const y = d.getFullYear()
  const m = String(d.getMonth()+1).padStart(2,'0')
  const day = String(d.getDate()).padStart(2,'0')
  return `${y}-${m}-${day}`
}
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x }
function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x }
function startOfMonthDate(y,m){ return new Date(y, m, 1) }
function endOfMonthDate(y,m){ return new Date(y, m+1, 0, 23,59,59,999) }
function startOfMonth(d){ return startOfMonthDate(d.getFullYear(), d.getMonth()) }
function endOfMonth(d){ return endOfMonthDate(d.getFullYear(), d.getMonth()) }
function addDays(d,days){ const x=new Date(d); x.setDate(x.getDate()+days); return x }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate() }
function getMonday(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x }
function isoWeekLabel(d){
  const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()))
  const dayNum = dt.getUTCDay() || 7
  dt.setUTCDate(dt.getUTCDate() + 4 - dayNum)
  const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1))
  const week = Math.ceil((((dt - yearStart)/86400000) + 1)/7)
  return `${dt.getUTCFullYear()}-W${String(week).padStart(2,'0')}`
}
function seasonRange(year, season){
  if(season==='spring') return { start: new Date(year,2,1), end: endOfMonthDate(year,4) } // –º–∞—Ä-–º–∞–π
  if(season==='summer') return { start: new Date(year,5,1), end: endOfMonthDate(year,7) } // –∏—é–Ω-–∞–≤–≥
  if(season==='autumn') return { start: new Date(year,8,1), end: endOfMonthDate(year,10) } // —Å–µ–Ω-–Ω–æ—è
  // winter: –¥–µ–∫–∞–±—Ä—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≥–æ–¥–∞ ‚Äî —Ñ–µ–≤—Ä–∞–ª—å —Ç–µ–∫—É—â–µ–≥–æ
  return { start: new Date(year-1,11,1), end: endOfMonthDate(year,1) }
}
function resolveSelectedRange(){
  const now = new Date()
  if(PERIOD_FILTER.mode==='month' && PERIOD_FILTER.singleMonth){
    const [y,m] = PERIOD_FILTER.singleMonth.split('-').map(Number)
    return { start: startOfMonthDate(y, m-1), end: endOfMonthDate(y, m-1) }
  }
  if(PERIOD_FILTER.mode==='period' && PERIOD_FILTER.fromMonth && PERIOD_FILTER.toMonth){
    const [y1,m1] = PERIOD_FILTER.fromMonth.split('-').map(Number)
    const [y2,m2] = PERIOD_FILTER.toMonth.split('-').map(Number)
    return { start: startOfMonthDate(y1, m1-1), end: endOfMonthDate(y2, m2-1) }
  }
  if(PERIOD_FILTER.mode==='year' && PERIOD_FILTER.singleYear){
    const y = Number(PERIOD_FILTER.singleYear)
    return { start: new Date(y,0,1), end: endOfMonthDate(y,11) }
  }
  if(PERIOD_FILTER.mode==='season' && PERIOD_FILTER.singleYear){
    const y = Number(PERIOD_FILTER.singleYear)
    const s = PERIOD_FILTER.singleSeason||'spring'
    return seasonRange(y, s)
  }
  if(PERIOD_FILTER.mode==='week'){
    const y = Number(PERIOD_FILTER.weekYear || now.getFullYear())
    const w = Number(PERIOD_FILTER.weekNumber || 1)
    // ISO week start (Mon): find Thursday of week to determine date, then back to Monday
    const simple = new Date(Date.UTC(y,0,1))
    const dayOfWeek = simple.getUTCDay() || 7
    const thursday = new Date(simple)
    thursday.setUTCDate(simple.getUTCDate() + (4 - dayOfWeek))
    const weekStart = new Date(thursday)
    weekStart.setUTCDate(thursday.getUTCDate() - ((thursday.getUTCDay()||7) - 1) + (w-1)*7)
    const start = new Date(weekStart.getUTCFullYear(), weekStart.getUTCMonth(), weekStart.getUTCDate())
    const end = addDays(start,6)
    return { start: startOfDay(start), end: endOfDay(end) }
  }
  if(PERIOD_FILTER.mode==='day'){
    const y = Number(PERIOD_FILTER.dayYear || now.getFullYear())
    const m = Number(PERIOD_FILTER.dayMonth || (now.getMonth()+1))
    const d = Number(PERIOD_FILTER.dayDay || 1)
    const start = new Date(y, m-1, d)
    return { start: startOfDay(start), end: endOfDay(start) }
  }
  // –§–æ–ª–±—ç–∫: –≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ –¥–∞–Ω–Ω—ã–º
  const {months}=monthBuckets()
  if(months.length){
    const [y1,m1] = months[0].split('-').map(Number)
    const [y2,m2] = months[months.length-1].split('-').map(Number)
    return { start: startOfMonthDate(y1,m1-1), end: endOfMonthDate(y2,m2-1) }
  }
  return { start: startOfMonth(now), end: endOfMonth(now) }
}
function generateBuckets(range, kind){
  const buckets=[]
  if(kind==='month'){
    let y=range.start.getFullYear(), m=range.start.getMonth()
    const yEnd=range.end.getFullYear(), mEnd=range.end.getMonth()
    while(y<yEnd?true:(y===yEnd && m<=mEnd)){
      const s=new Date(y,m,1)
      const e=endOfMonthDate(y,m)
      buckets.push({ label: `${y}-${String(m+1).padStart(2,'0')}`, start:s, end:e })
      m++; if(m>11){ m=0; y++ }
      if(y>yEnd || (y===yEnd && m>mEnd)) break
    }
  }else if(kind==='week'){
    let s = getMonday(range.start)
    while(s <= range.end){
      const e = addDays(s,6)
      buckets.push({ label: isoWeekLabel(s), start: s, end: endOfDay(e) })
      s = addDays(s,7)
    }
  }else if(kind==='day'){
    let s = startOfDay(range.start)
    while(s <= range.end){
      buckets.push({ label: formatISODate(s), start: s, end: endOfDay(s) })
      s = addDays(s,1)
    }
  }
  return buckets
}

// ===== –®–ò–§–†–û–í–ê–ù–ò–ï (WebCrypto) =====
const KDF_ITER = 250000
async function deriveKey(pass, salt){
  const enc = new TextEncoder()
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey'])
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:KDF_ITER,hash:'SHA-256'}, keyMaterial, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt'])
}
async function encryptJSON(obj, pass){
  const salt = crypto.getRandomValues(new Uint8Array(16))
  const iv = crypto.getRandomValues(new Uint8Array(12))
  const key = await deriveKey(pass, salt)
  const enc = new TextEncoder()
  const data = enc.encode(JSON.stringify(obj))
  const cipher = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, data))
  return {v:1,algo:'AES-GCM',kdf:'PBKDF2',iter:KDF_ITER,salt:b64.enc(salt),iv:b64.enc(iv),data:b64.enc(cipher)}
}
async function decryptJSON(bundle, pass){
  const salt=b64.dec(bundle.salt), iv=b64.dec(bundle.iv), data=b64.dec(bundle.data)
  const key = await deriveKey(pass, salt)
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, data)
  const dec = new TextDecoder()
  return JSON.parse(dec.decode(new Uint8Array(plain)))
}

// ===== –•–†–ê–ù–ò–õ–ò–©–ï =====
const LS_KEY = 'ofb_vault'
const DEMO_BACKUP_KEY = 'ofb_demo_backup'
let STATE = { unlocked:true, pass:null, vault: ensureVault(loadVaultPlain()) }

// ===== –§–ò–õ–¨–¢–† –ü–ï–†–ò–û–î–ê =====
let PERIOD_FILTER = {
  mode: 'year',                 // 'year' | 'season' | 'month' | 'period' | 'week' | 'day'
  // month/year/period
  fromMonth: null,
  toMonth: null,
  singleMonth: null,
  singleYear: null,
  // seasons
  singleSeason: 'spring',
  // week selection
  weekYear: null,
  weekNumber: null,
  // day selection
  dayYear: null,
  dayMonth: null,
  dayDay: null
}
// –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–π: 'all' | 'income' | 'expense'
let TX_FILTER = (window.UI && UI.txFilter) ? UI.txFilter : 'all'

function ensureVault(v){
  try{
    if(!v || typeof v!=='object') return emptyVault()
    if(!Array.isArray(v.transactions)) v.transactions=[]
    if(!v.adjustments || typeof v.adjustments!=='object') v.adjustments={}
    if(!v.currency) v.currency='BGN'
    if(!Array.isArray(v.categories)) v.categories=[]
    if(!Array.isArray(v.catRules)) v.catRules=[]
    return v
  }catch{ return emptyVault() }
}

function loadBundle(){
  const raw = localStorage.getItem(LS_KEY)
  return raw?JSON.parse(raw):null
}
function loadVaultPlain(){
  try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null }catch{ return null }
}
async function saveVault(){
  if(!STATE.vault) return
  localStorage.setItem(LS_KEY, JSON.stringify(STATE.vault))
  toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ')
}

// –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏ UI –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∏–º–ø–æ—Ä—Ç–æ–º
function resetBeforeImport(kind){
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ –º–µ–∂–¥—É –∏–º–ø–æ—Ä—Ç–∞–º–∏
  const preservedCats = (STATE?.vault?.categories)||[]
  const preservedRules = (STATE?.vault?.catRules)||[]
  try{ localStorage.removeItem(LS_KEY) }catch(e){}
  STATE = {unlocked:true, pass:null, vault: emptyVault()}
  if(Array.isArray(preservedCats) && preservedCats.length) STATE.vault.categories = preservedCats
  if(Array.isArray(preservedRules) && preservedRules.length) STATE.vault.catRules = preservedRules
  window.UI = {}
  // –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ç–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏–º –≤—ã–±–æ—Ä XML
  if(kind==='vault'){
    try{ clearFile('stmtFile') }catch(e){}
    try{ clearStmtSelection() }catch(e){}
  }
  render()
}

function setCurrency(cur){
  try{STATE.vault.currency=cur; (fmt.resolvedOptions().currency!==cur);} 
  catch(e){}
  // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
  window.fmt = new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur,maximumFractionDigits:2})
  render()
}

// ===== –¢–û–°–¢ =====
let toastTimer=null
function toast(text,kind='success'){
  clearTimeout(toastTimer)
  let el=$('#toast')
  if(!el){
    el=document.createElement('div')
    el.id='toast'
    el.style.position='fixed';el.style.right='16px';el.style.bottom='16px';el.style.zIndex='9999';el.style.maxWidth='320px'
    document.body.appendChild(el)
  }
  el.innerHTML = `<div class="${kind==='success'?'success':'warnbox'}">${text}</div>`
  toastTimer=setTimeout(()=>{el.innerHTML=''},2400)
}

// ===== –ü–ê–†–°–ò–ù–ì –î–ê–¢–´/CSV =====
function parseDateFlexible(s){
  s = (s||'').trim()
  // –ø–æ–¥–¥–µ—Ä–∂–∫–∞: YYYY-MM-DD, DD.MM.YYYY, MM/DD/YYYY, DD/MM/YYYY
  let m
  if((m=s.match(/^(\d{4})[-.\/]?(\d{2})[-.\/]?(\d{2})$/))) return new Date(+m[1],+m[2]-1,+m[3])
  if((m=s.match(/^(\d{2})[.](\d{2})[.](\d{4})$/))) return new Date(+m[3],+m[2]-1,+m[1])
  if((m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/))){
    // –í—Å–µ–≥–¥–∞ —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ DD/MM/YYYY (–µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
    const d=+m[1], mo=+m[2], y=+m[3]
    return new Date(y,mo-1,d)
  }
  const d=new Date(s); if(!isNaN(d)) return d
  return null
}

function detectDelimiter(text){
  const candidates=[',',';','\t','|']
  const lines=text.split(/\r?\n/).slice(0,5)
  let best=',',score=0
  for(const d of candidates){
    const counts=lines.map(l=>l.split(d).length)
    const uniq=new Set(counts)
    const s = counts.reduce((a,b)=>a+b,0)
    if(uniq.size===1 && s>score){best=d;score=s}
  }
  return best
}

function parseCSV(text){
  const delim = detectDelimiter(text)
  const rows=[]; let i=0, cur='', inQ=false
  function pushCell(){(rows[rows.length-1]||rows.push([]),rows[rows.length-1]).push(cur);cur=''}
  function pushRow(){if(rows.length===0||rows[rows.length-1].length) rows.push([])}
  rows.push([])
  while(i<text.length){
    const ch=text[i]
    if(ch==='"'){
      if(inQ && text[i+1]==='"'){cur+='"'; i+=2; continue}
      inQ=!inQ; i++; continue
    }
    if(!inQ && (ch==='\n' || ch==='\r')){ pushCell(); pushRow(); if(ch==='\r'&&text[i+1]==='\n') i++; i++; continue }
    if(!inQ && text.substr(i,delim.length)===delim){ pushCell(); i+=delim.length; continue }
    cur+=ch; i++
  }
  pushCell()
  // —É–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ –ø–æ—Å–ª–µ–¥–Ω—é—é/–ø–µ—Ä–≤—É—é
  return rows.filter(r=>r.length && r.some(c=>String(c).trim().length))
}

// ===== –ú–û–î–ï–õ–¨ –î–ê–ù–ù–´–• =====
function defaultCategoriesAndRules(){
  const categories = [
    '–ü—Ä–æ–¥—É–∫—Ç—ã',
    '–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã',
    '–ê–ø—Ç–µ–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ',
    '–¢–æ–ø–ª–∏–≤–æ –∏ –∞–≤—Ç–æ',
    '–°–≤—è–∑—å –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç',
    '–û–¥–µ–∂–¥–∞ –∏ —Ç–æ–≤–∞—Ä—ã',
    '–î–æ–º –∏ –±—ã—Ç',
    '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
    '–ö—Ä–∞—Å–æ—Ç–∞',
    '–ò–≥—Ä—ã –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞',
    '–ó–∞—Ä–ø–ª–∞—Ç–∞',
    '–ê—Ä–µ–Ω–¥–∞',
    '–ö–æ–º–∏—Å—Å–∏–∏',
    '–ü–µ—Ä–µ–≤–æ–¥—ã'
  ]
  const pairs = [
    // –ü—Ä–æ–¥—É–∫—Ç—ã / —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã
    ['lidl','–ü—Ä–æ–¥—É–∫—Ç—ã'],['kaufland','–ü—Ä–æ–¥—É–∫—Ç—ã'],['ebag','–ü—Ä–æ–¥—É–∫—Ç—ã'],['fantastico','–ü—Ä–æ–¥—É–∫—Ç—ã'],['plodove i zelenchutsi','–ü—Ä–æ–¥—É–∫—Ç—ã'],
    // –ö–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
    ['ma baker','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['soho cafe','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['gorski kanton','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['tera burger','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['sen viet','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['praga','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['fresh and fruits','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['yunak coffee','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],['amora dzhelato','–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'],
    // –ê–ø—Ç–µ–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
    ['sopharmacy','–ê–ø—Ç–µ–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ'],['pharma choice','–ê–ø—Ç–µ–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ'],['kazakov dental','–ê–ø—Ç–µ–∫–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ'],
    // –¢–æ–ø–ª–∏–≤–æ –∏ –∞–≤—Ç–æ / —Å–µ—Ä–≤–∏—Å—ã / –¥–æ—Å—Ç–∞–≤–∫–∞
    ['oil trade 78','–¢–æ–ø–ª–∏–≤–æ –∏ –∞–≤—Ç–æ'],['sis invest auto','–¢–æ–ø–ª–∏–≤–æ –∏ –∞–≤—Ç–æ'],['speedy','–¢–æ–ø–ª–∏–≤–æ –∏ –∞–≤—Ç–æ'],
    // –°–≤—è–∑—å
    ['vivacom','–°–≤—è–∑—å –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç'],
    // –û–¥–µ–∂–¥–∞/—Ç–æ–≤–∞—Ä—ã/–¥–µ—Ç–∏
    ['pepko','–û–¥–µ–∂–¥–∞ –∏ —Ç–æ–≤–∞—Ä—ã'],['jumbo','–û–¥–µ–∂–¥–∞ –∏ —Ç–æ–≤–∞—Ä—ã'],
    // –î–æ–º –∏ –±—ã—Ç
    ['bedroom gallery','–î–æ–º –∏ –±—ã—Ç'],['vodolei 10','–î–æ–º –∏ –±—ã—Ç'],['linos trading','–î–æ–º –∏ –±—ã—Ç'],['dims-92','–î–æ–º –∏ –±—ã—Ç'],
    // –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è/–ø–∞—Ä–∫–∏
    ['kokolandia','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'],['lazy park','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'],['yuzhen park','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'],['kamelot','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'],['sail with me','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è'],
    // –ö—Ä–∞—Å–æ—Ç–∞
    ['diamond nail studio','–ö—Ä–∞—Å–æ—Ç–∞'],
    // –ò–≥—Ä—ã/—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞
    ['pulsar','–ò–≥—Ä—ã –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'],
    // –ó–∞—Ä–ø–ª–∞—Ç–∞ / –¥–æ—Ö–æ–¥
    ['sitecore bulgaria','–ó–∞—Ä–ø–ª–∞—Ç–∞'],['–±–∏—Å–µ—Ä–∞','–ó–∞—Ä–ø–ª–∞—Ç–∞'],
    // –ê—Ä–µ–Ω–¥–∞
    ['–Ω–∞–µ–º','–ê—Ä–µ–Ω–¥–∞'],
    // –ö–æ–º–∏—Å—Å–∏–∏
    ['—Ç–∞–∫—Å–∞','–ö–æ–º–∏—Å—Å–∏–∏'],
    // –ü–µ—Ä–µ–≤–æ–¥—ã
    ['–ø—Ä–µ–≤–æ–¥','–ü–µ—Ä–µ–≤–æ–¥—ã'],['sepa','–ü–µ—Ä–µ–≤–æ–¥—ã'],
  ]
  const catRules = pairs.map(([m,c])=>({id:uid(), match:m, category:c}))
  return {categories, catRules}
}
function emptyVault(){
  return {
    currency:'BGN',
    transactions:[], // {id,date:ISO,desc,amount:number,category?:string,source:'import'|'manual'}
    adjustments:{}, // { 'YYYY-MM': number }
    ...defaultCategoriesAndRules(),
    createdAt: new Date().toISOString(),
    version:1
  }
}

function addTransactions(list){
  for(const t of list){ STATE.vault.transactions.push(t) }
}

function addManual(tx){ STATE.vault.transactions.push(tx) }

function setAdjustment(month, amount){ STATE.vault.adjustments[month]=amount }

function monthBuckets(){
  const byM = {}
  for(const t of STATE.vault.transactions){
    const d=new Date(t.date), m=monthKey(d)
    ;(byM[m]||(byM[m]={income:0,expense:0,net:0,items:[],byCat:{}}))
    byM[m].items.push(t)
    if(t.amount>=0) byM[m].income+=t.amount; else byM[m].expense+=-t.amount
    byM[m].net += t.amount
    const cat=t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
    byM[m].byCat[cat]=(byM[m].byCat[cat]||0)+Math.abs(t.amount)
  }
  for(const m in STATE.vault.adjustments){
    const a=STATE.vault.adjustments[m]||0
    ;(byM[m]||(byM[m]={income:0,expense:0,net:0,items:[],byCat:{}}))
    byM[m].net += a
    if(a>=0) byM[m].income += a; else byM[m].expense += -a
    byM[m].byCat['–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏']=(byM[m].byCat['–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏']||0)+Math.abs(a)
  }
  const months=Object.keys(byM).sort()
  return {months, byM}
}

function filteredMonthBuckets(){
  const {months, byM} = monthBuckets()
  
  if(PERIOD_FILTER.mode === 'month' && PERIOD_FILTER.singleMonth) {
    // –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    const filteredMonths = months.filter(m => m === PERIOD_FILTER.singleMonth)
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'period' && PERIOD_FILTER.fromMonth && PERIOD_FILTER.toMonth) {
    // –†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∞
    const filteredMonths = months.filter(m => m >= PERIOD_FILTER.fromMonth && m <= PERIOD_FILTER.toMonth)
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'year' && PERIOD_FILTER.singleYear) {
    // –†–µ–∂–∏–º –≥–æ–¥–∞
    const y = PERIOD_FILTER.singleYear
    const filteredMonths = months.filter(m => m.startsWith(y + '-'))
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'quarter' && PERIOD_FILTER.singleYear) {
    const y = Number(PERIOD_FILTER.singleYear)
    const q = Number(PERIOD_FILTER.singleQuarter||1)
    const startMonth = (q-1)*3 + 1
    const endMonth = startMonth + 2
    const filteredMonths = months.filter(m => {
      const [ys,ms] = m.split('-').map(Number)
      if(ys!==y) return false
      return ms>=startMonth && ms<=endMonth
    })
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'season' && PERIOD_FILTER.singleYear) {
    const y = Number(PERIOD_FILTER.singleYear)
    const range = seasonRange(y, PERIOD_FILTER.singleSeason||'spring')
    const filteredMonths = months.filter(m => {
      const [ys,ms] = m.split('-').map(Number)
      const first = new Date(ys, ms-1, 1)
      const last = endOfMonthDate(ys, ms-1)
      return last >= range.start && first <= range.end
    })
    return {months: filteredMonths, byM}
  }
  
  return {months, byM}
}

function filteredTransactions(){
  function categoryMatch(t){
    const cat = t.category || ''
    if(CAT_FILTER==='all') return true
    if(CAT_FILTER==='__none__') return !cat
    return cat === CAT_FILTER
  }
  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
  const range = resolveSelectedRange()
  const start = range.start
  const end = range.end
  return STATE.vault.transactions.filter(t => {
    const d = new Date(t.date)
    if(!(d>=start && d<=end)) return false
    if(!categoryMatch(t)) return false
    if(TX_FILTER==='income') return (t.amount||0) >= 0
    if(TX_FILTER==='expense') return (t.amount||0) < 0
    return true
  })
}

// –û—Ç–¥–µ–ª—å–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã —Ä–∞—Å—Ö–æ–¥–æ–≤: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function filteredTransactionsWithoutCategory(){
  const range = resolveSelectedRange()
  const start = range.start
  const end = range.end
  return STATE.vault.transactions.filter(t=>{
    const d = new Date(t.date)
    if(!(d>=start && d<=end)) return false
    if(TX_FILTER==='income') return (t.amount||0) >= 0
    if(TX_FILTER==='expense') return (t.amount||0) < 0
    return true
  })
}

// –ü–æ–¥—Å—á—ë—Ç –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–º–µ—Å—è—á–Ω–æ
function computeMonthlySumsByCategory(filteredMonths){
  const monthsSet = new Set(filteredMonths||[])
  const result = {}
  const target = CAT_FILTER || 'all'
  for(const t of STATE.vault.transactions){
    const m = monthKey(new Date(t.date))
    if(!monthsSet.has(m)) continue
    const cat = t.category || ''
    if(target==='__none__' && cat) continue
    if(target!=='all' && target!=='__none__' && cat !== target) continue
    const amount = +t.amount || 0
    const slot = (result[m]||(result[m]={income:0,expense:0}))
    if(amount>=0) slot.income += amount; else slot.expense -= Math.min(0, amount)
  }
  return result
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–æ –≤—Å–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
function applyCatRulesToAllTransactions(){
  try{
    const rules = (STATE.vault.catRules||[]).map(r=>({match:String(r.match||'').toLowerCase(), category:r.category}))
    for(const t of STATE.vault.transactions){
      const hay = [t.desc, t.trName, t.nameR, t.remI, t.remII].map(x=>String(x||'').toLowerCase()).join(' | ')
      const hit = rules.find(r=> r.match && hay.includes(r.match))
      t.category = hit ? hit.category : null
    }
  }catch(_){ }
}

// ===== –†–ï–ù–î–ï–† =====
function render(){
  // –£–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å –∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –¥–∞—à–±–æ—Ä–¥
  const appEl = document.querySelector('.app'); if(appEl) appEl.classList.add('no-side')
  $('#side').innerHTML = ''
  $('#main').innerHTML = mainUI()
  bindSide()
  bindMain()
}

// –≤—ã–∫–ª—é—á–µ–Ω–æ: —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –±–µ–∑ –ø–∞—Ä–æ–ª—è

function sideUI(){
  return `
  
  <!-- –ó–æ–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
  <div id="stmtDropzone" class="dropzone">
    <label id="btnChooseStmt" class="btn" for="stmtFile">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
    <input id="stmtFile" type="file" accept=".xml,text/xml,application/xml,application/json,.json" class="hidden" onchange="onStmtChosen(event)" />
    <div class="help" style="margin-top:8px">XML (–±–∞–Ω–∫) –∏–ª–∏ JSON (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —ç–∫—Å–ø–æ—Ä—Ç). –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å —Å—é–¥–∞.</div>
  </div>
  
  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ -->
  <div id="stmtFileInfo" style="display:none;margin-top:12px;padding:12px;background:var(--card);border:1px solid var(--accent);border-radius:8px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="color:var(--accent);font-size:16px;">‚úì</span>
      <div id="stmtFileName" style="font-weight:600;color:var(--text);"></div>
    </div>
    <div id="stmtInfo" style="color:var(--accent);font-weight:500;margin-bottom:4px;"></div>
    <div id="stmtStatus" style="color:var(--muted);font-size:12px;"></div>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div class="hr"></div>
  <div class="controls">
    <button id="btnClearStmt" class="btn" disabled>–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button id="btnDoImportStmt" class="primary" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <span class="right"></span>
    <button id="btnExportVault" class="btn">–≠–∫—Å–ø–æ—Ä—Ç (JSON)</button>
  </div>
  
  `
}

function mainUI(){
  const {months,byM}=monthBuckets()
  const lastM = months[months.length-1]
  const curr = STATE.vault.currency
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
  if(months.length > 0){
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    // populate years select later in bindMain
    if(!PERIOD_FILTER.singleYear){ PERIOD_FILTER.singleYear = years[years.length-1] }
    if(!PERIOD_FILTER.fromMonth){ PERIOD_FILTER.fromMonth = months[0] }
    if(!PERIOD_FILTER.toMonth){ PERIOD_FILTER.toMonth = months[months.length-1] }
    if(!PERIOD_FILTER.singleMonth){ PERIOD_FILTER.singleMonth = lastM || months[months.length-1] }
  }
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–∞ (—Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
  const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
  const sumsCat0 = computeMonthlySumsByCategory(filteredMonths)
  const totalIncome = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='expense')?0:(sumsCat0[m]?.income||0)),0)
  const totalExpense = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='income')?0:(sumsCat0[m]?.expense||0)),0)
  const totalNet = totalIncome - totalExpense
  
  const allSearched = getFilteredAndSearchedTransactions()
  const recent = allSearched.slice(0, RECENT_LIMIT)

  return `
  <div id="helpBlock" style="display:none">${helpHTML()}</div>
  <div class="card filter-card">
    <div class="filter-header">
      <h3>–§–∏–ª—å—Ç—Ä –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
      <div class="inline"><button id="btnOpenStmt" class="btn">–í—ã–ø–∏—Å–∫–∏</button><button id="btnOpenCats" class="btn">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button><button id="btnOpenAdd" class="primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button></div>
    </div>
    
    <div class="filter-body">
      <div class="filter-controls-grid">
        <div class="filter-section">
          <label class="filter-label">–û–ø–µ—Ä–∞—Ü–∏–∏</label>
          <div class="filter-mode-tabs">
            <label class="filter-tab">
              <input type="radio" name="txFilter" value="all" ${TX_FILTER==='all'?'checked':''}>
              <span>–í—Å–µ</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="txFilter" value="income" ${TX_FILTER==='income'?'checked':''}>
              <span>–î–æ—Ö–æ–¥—ã</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="txFilter" value="expense" ${TX_FILTER==='expense'?'checked':''}>
              <span>–†–∞—Å—Ö–æ–¥—ã</span>
            </label>
          </div>
          <div id="categoryFilterSection" class="filter-section" style="margin-top:8px">
            <label class="filter-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select id="catFilterGlobal" class="filter-select"><option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option><option value="__none__">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>${(STATE.vault.categories||[]).map(c=>`<option ${CAT_FILTER===c?'selected':''} value="${c}">${c}</option>`).join('')}</select>
          </div>
        </div>
        
        <div class="filter-section">
          <label class="filter-label">–ü–µ—Ä–∏–æ–¥</label>
          <div class="filter-mode-tabs">
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="year" ${PERIOD_FILTER.mode==='year'?'checked':''}>
              <span>–ì–æ–¥</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="season" ${PERIOD_FILTER.mode==='season'?'checked':''}>
              <span>–°–µ–∑–æ–Ω</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="month" ${PERIOD_FILTER.mode==='month'?'checked':''}>
              <span>–ú–µ—Å—è—Ü</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="week" ${PERIOD_FILTER.mode==='week'?'checked':''}>
              <span>–ù–µ–¥–µ–ª—è</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="day" ${PERIOD_FILTER.mode==='day'?'checked':''}>
              <span>–î–µ–Ω—å</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="period" ${PERIOD_FILTER.mode==='period'?'checked':''}>
              <span>–î–∏–∞–ø–∞–∑–æ–Ω</span>
            </label>
          </div>
          <div id="categoryFilterSection" class="filter-section" style="margin-top:8px">
            <div id="yearControls" class="filter-param-group">
              <select id="globalYear" class="filter-select"></select>
            </div>
            <div id="seasonControls" class="filter-param-group" style="display:none">
              <label>–°–µ–∑–æ–Ω</label>
              <select id="seasonCombined" class="filter-select"></select>
            </div>
            <div id="monthControls" class="filter-param-group" style="display:none">
              <select id="globalSingleMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.singleMonth?'selected':''}>${m}</option>`).join('')}</select>
            </div>
            <div id="periodControls" class="filter-param-group period-group" style="display:none">
              <div class="period-inputs">
                <div class="period-input">
                  <label>–û—Ç</label>
                  <select id="globalFromMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.fromMonth?'selected':''}>${m}</option>`).join('')}</select>
                </div>
                <div class="period-input">
                  <label>–î–æ</label>
                  <select id="globalToMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.toMonth?'selected':''}>${m}</option>`).join('')}</select>
                </div>
              </div>
            </div>
            <div id="weekControls" class="filter-param-group period-group" style="display:none">
              <div class="period-inputs">
                <div class="period-input">
                  <label>–ì–æ–¥</label>
                  <select id="weekYear" class="filter-select"></select>
                </div>
                <div class="period-input">
                  <label>–ù–µ–¥–µ–ª—è</label>
                  <select id="weekNumber" class="filter-select"></select>
                </div>
              </div>
            </div>
            <div id="dayControls" class="filter-param-group period-group" style="display:none">
              <div class="period-inputs">
                <div class="period-input">
                  <label>–ì–æ–¥</label>
                  <select id="dayYear" class="filter-select"></select>
                </div>
                <div class="period-input">
                  <label>–ú–µ—Å—è—Ü</label>
                  <select id="dayMonth" class="filter-select"></select>
                </div>
                <div class="period-input">
                  <label>–î–µ–Ω—å</label>
                  <select id="dayDay" class="filter-select"></select>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="filter-section">
          <label class="filter-label">–ê–≥—Ä–µ–≥–∞—Ü–∏—è</label>
          <div class="filter-mode-tabs">
            <label class="filter-tab">
              <input type="radio" name="aggMode" value="month" ${ (window.UI&&UI.aggMode?UI.aggMode:'month')==='month'?'checked':'' }>
              <span>–ú–µ—Å—è—Ü</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="aggMode" value="week" ${ (window.UI&&UI.aggMode?UI.aggMode:'month')==='week'?'checked':'' }>
              <span>–ù–µ–¥–µ–ª—è</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="aggMode" value="day" ${ (window.UI&&UI.aggMode?UI.aggMode:'month')==='day'?'checked':'' }>
              <span>–î–µ–Ω—å</span>
            </label>
          </div>
          <div id="categoryFilterSection" class="filter-section" style="margin-top:8px">
            <label class="filter-label">–ü—Ä–æ–≥–Ω–æ–∑</label>
            <div class="filter-mode-tabs">
              <label class="filter-tab">
                <input type="radio" name="forecastMode" value="off" ${ !(window.UI&&UI.forecast)?'checked':'' }>
                <span>–í—ã–∫–ª</span>
              </label>
              <label class="filter-tab">
                <input type="radio" name="forecastMode" value="eoy" ${ (window.UI&&UI.forecast)?'checked':'' }>
                <span>–î–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞</span>
              </label>
              <label class="filter-tab">
                <input type="radio" name="forecastMode" value="avg12" ${ (window.UI&&UI.forecastMode==='avg12')?'checked':'' }>
                <span>–°—Ä. –¥–æ—Ö–æ–¥</span>
              </label>
              <label class="filter-tab">
                <input type="radio" name="forecastMode" value="avg12both" ${ (window.UI&&UI.forecastMode==='avg12both')?'checked':'' }>
                <span>–°—Ä. –¥–æ—Ö–æ–¥ / —Ä–∞—Å—Ö–æ–¥</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div class="filter-stats-row">
        <div class="stat-card income">
          <span class="stat-label">–î–æ—Ö–æ–¥—ã</span>
          <span id="incomeValue" class="stat-value">${formatAmountDisplay(totalIncome)}</span>
        </div>
        <div class="stat-card expense">
          <span class="stat-label">–†–∞—Å—Ö–æ–¥—ã</span>
          <span id="expenseValue" class="stat-value">${formatAmountDisplay(totalExpense)}</span>
        </div>
        <div class="stat-card net ${totalNet>=0?'positive':'negative'}">
          <span class="stat-label">–ò—Ç–æ–≥–æ</span>
          <span id="netValue" class="stat-value">${formatAmountDisplay(totalNet)}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row cols-2" style="margin-top:12px">
    <div class="card"><div class="controls"><b>–î–æ—Ö–æ–¥—ã / –†–∞—Å—Ö–æ–¥—ã</b><span class="right"></span><button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="bar">‚§¢</button></div><canvas id="bar"></canvas></div>
    <div class="card"><div class="controls"><b>–ß–∏—Å—Ç—ã–π –∏—Ç–æ–≥</b><span class="right"></span><button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="line">‚§¢</button></div><canvas id="line"></canvas></div>
  </div>

  <div class="row cols-2" style="margin-top:12px">
    <div class="card">
      <div class="controls"><b>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</b>
        <span class="right"></span>
        <button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="pie">‚§¢</button>
      </div>
      <canvas id="pie"></canvas>
    </div>
    <div class="card">
      <div class="controls">
        <b>–û–ø–µ—Ä–∞—Ü–∏–∏</b>
        <span class="right"></span>
        <label class="pill">–ü–æ—Å–ª–µ–¥–Ω–∏–µ <input id="recentLimit" type="number" min="1" max="50" value="${RECENT_LIMIT}"> –∏–∑ <span id="recentTotalCount">${allSearched.length}</span></label>
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é..." value="${SEARCH_TEXT}" class="search-ops">
        <button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="recent">‚§¢</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ <button data-copy-desc="1" class="icon-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è (JSON)">üìã</button></th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style="text-align:right">–°—É–º–º–∞</th><th></th></tr></thead>
          <tbody>
            ${recent.map(t=>`<tr title="${(()=>{const a=[]; if(t.trName) a.push('TR_NAME: '+escapeHtml(t.trName)); if(t.nameR) a.push('NAME_R: '+escapeHtml(t.nameR)); if(t.remI) a.push('REM_I: '+escapeHtml(t.remI)); if(t.remII) a.push('REM_II: '+escapeHtml(t.remII)); return a.join('\\n');})()}"><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${t.category?`<button class=\"btn-small\" title=\"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat-cat=\"${escapeHtml(t.category)}\">‚úé</button> ${escapeHtml(t.category)}`:`<button class=\"btn-small\" title=\"–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat=\"${t.id}\">‚úé</button>`}</td><td style=\"text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}\">${formatAmountDisplay(t.amount)}</td><td style=\"width:32px;text-align:right;\">${t.source==='manual'?`<button class=\"btn-small\" data-del-tx=\"${t.id}\">üóë</button>`:''}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="dashOverlay" class="overlay"></div>
  <div id="dashModal" class="modal">
    <div class="head inline"><h3 id="dashModalTitle" style="margin:0"></h3><span class="right"></span><button id="btnCloseDashModal" class="icon-btn" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button></div>
    <div id="dashModalContent"></div>
  </div>`
}

function bindMain(){
  const {months,byM}=monthBuckets()
  
  // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑
  function getISOWeekYear(d){
    const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()))
    const dayNum = dt.getUTCDay() || 7
    dt.setUTCDate(dt.getUTCDate() + 4 - dayNum)
    const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1))
    const week = Math.ceil((((dt - yearStart)/86400000) + 1)/7)
    return {year: dt.getUTCFullYear(), week}
  }
  function monthStr(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` }
  function endOfYearDate(d){ return new Date(d.getFullYear(),11,31) }
  function startOfNextMonth(ym){ const [y,m]=ym.split('-').map(Number); return new Date(y, m, 1) }
  function aggregateForCharts(){
    const aggMode = (window.UI&&UI.aggMode)||'month'
    const forecastMode = (window.UI && UI.forecastMode) || ((window.UI&&UI.forecast)?'eoy':'off')
    const range = resolveSelectedRange()
    const kind = aggMode==='week' ? 'week' : aggMode==='day' ? 'day' : 'month'
    const buckets = generateBuckets(range, kind)
    const labels = buckets.map(b=>b.label)
    const tx = filteredTransactions()
    function keyOf(d){
      if(kind==='month') return monthKey(d)
      if(kind==='week') return isoWeekLabel(d)
      return String(formatISODate(d))
    }
    const sums = new Map()
    for(const t of tx){
      const d = new Date(t.date)
      const k = keyOf(d)
      const slot = sums.get(k) || {inc:0,exp:0}
      const a=+t.amount||0
      if(a>=0) slot.inc += a; else slot.exp += -a
      sums.set(k, slot)
    }
    let incomes = labels.map(l=> (sums.get(l)?.inc||0))
    let expenses = labels.map(l=> (sums.get(l)?.exp||0))
    const hasActual = labels.map(l=> ((sums.get(l)?.inc||0)!==0) || ((sums.get(l)?.exp||0)!==0))
    let forecastFromIndex = null
    if(forecastMode==='eoy' && labels.length){
      // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞—á–∏–Ω–∞—è —Å –ø–µ—Ä–≤–æ–π –±—É–¥—É—â–µ–π –∫–æ—Ä–∑–∏–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –¥–∞—Ç—ã —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      const txAll = filteredTransactions()
      const lastActualDate = txAll.length ? new Date(Math.max(...txAll.map(t=>+new Date(t.date)))) : new Date()
      const idx = buckets.findIndex(b=> b.start > lastActualDate)
      if(idx>=0){
        forecastFromIndex = idx
        const baseSliceInc = incomes.slice(0, idx)
        const baseSliceExp = expenses.slice(0, idx)
        const avgInc = baseSliceInc.length ? baseSliceInc.reduce((a,b)=>a+b,0)/baseSliceInc.length : 0
        const avgExp = baseSliceExp.length ? baseSliceExp.reduce((a,b)=>a+b,0)/baseSliceExp.length : 0
        for(let i=idx;i<labels.length;i++){ incomes[i]=avgInc; expenses[i]=avgExp }
      }
    }
    // –ë–µ–π–∑–ª–∞–π–Ω –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –∑–∞ 12 –º–µ—Å, –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–π –∫ —Ç–µ–∫—É—â–µ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
    let baseline = null
    if(forecastMode==='avg12' || forecastMode==='avg12both'){
      const now = new Date()
      const start12 = new Date(now.getFullYear(), now.getMonth()-11, 1)
      const end12 = new Date(now.getFullYear(), now.getMonth()+1, 0)
      const monthly = {}
      function catMatchesForExpense(t){
        const cat = t.category || ''
        if(CAT_FILTER==='all') return true
        if(CAT_FILTER==='__none__') return !cat
        return cat === CAT_FILTER
      }
      for(const t of STATE.vault.transactions){
        const d=new Date(t.date)
        if(d>=start12 && d<=end12){
          const mk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`
          const slot = (monthly[mk]||(monthly[mk]={inc:0,exp:0,net:0}))
          const a=+t.amount||0
          if(a>=0){
            slot.inc+=a
            slot.net+=a
          }else{
            // –î–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º —É—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            if(catMatchesForExpense(t)){
              slot.exp+=-a
              slot.net+=a
            }
          }
        }
      }
      const months12 = Object.keys(monthly).sort()
      const avg = { inc:0, exp:0, net:0 }
      if(months12.length){
        for(const m of months12){ avg.inc+=monthly[m].inc; avg.exp+=monthly[m].exp; avg.net+=monthly[m].net }
        avg.inc/=months12.length; avg.exp/=months12.length; avg.net/=months12.length
      }
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥ –∞–≥—Ä–µ–≥–∞—Ü–∏—é
      let incScaled = avg.inc, expScaled = avg.exp
      if(kind==='week'){
        const coeff = 12/52; incScaled = avg.inc*coeff; expScaled = avg.exp*coeff
      }else if(kind==='day'){
        const coeff = 12/365; incScaled = avg.inc*coeff; expScaled = avg.exp*coeff
      }
      const netScaled = incScaled - expScaled
      // –õ–∏–Ω–∏—è-–±–µ–π–∑–ª–∞–π–Ω –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —á–∏—Å—Ç–æ–≥–æ –∏—Ç–æ–≥–∞ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â–∏–π TX_FILTER)
      if(TX_FILTER==='income') baseline = labels.map(()=>incScaled)
      else if(TX_FILTER==='expense') baseline = labels.map(()=>-expScaled)
      else baseline = labels.map(()=>netScaled)
      // –ü–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é: –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã –Ω–∞ —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–µ
      incomes = labels.map(()=>incScaled)
      if(forecastMode==='avg12both'){
        expenses = labels.map(()=>expScaled)
        // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ ¬´—Å—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥¬ª —Å—á–∏—Ç–∞–µ–º —á–∏—Å—Ç—ã–π –∏—Ç–æ–≥ –∫–∞–∫ –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–π (–ø—É–Ω–∫—Ç–∏—Ä)
        forecastFromIndex = 0
      }
    }
    if(TX_FILTER==='income'){ expenses = expenses.map(()=>0) }
    if(TX_FILTER==='expense'){ incomes = incomes.map(()=>0) }

    // –£–¥–∞–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—ã –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö: –Ω–µ —Ä–∏—Å—É–µ–º –Ω—É–ª–∏ –¥–ª—è –º–µ—Å—è—Ü–µ–≤/–Ω–µ–¥–µ–ª—å/–¥–Ω–µ–π –±–µ–∑ –æ–ø–µ—Ä–∞—Ü–∏–π.
    // –ü—Ä–æ–≥–Ω–æ–∑–Ω—ã–µ —Ç–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–µ–Ω—É–ª–µ–≤—ã–µ.
    const keepIdx = []
    for(let i=0;i<labels.length;i++){
      const isForecast = (forecastFromIndex!=null) && (i>=forecastFromIndex)
      const forecastNonZero = ((incomes[i]||0)!==0 || (expenses[i]||0)!==0)
      if(hasActual[i] || (isForecast && forecastNonZero)){
        keepIdx.push(i)
      }
    }
    let labelsF = labels, incomesF = incomes, expensesF = expenses, forecastFromIndexF = forecastFromIndex, baselineF = baseline
    if(keepIdx.length && keepIdx.length!==labels.length){
      labelsF = keepIdx.map(i=>labels[i])
      incomesF = keepIdx.map(i=>incomes[i])
      expensesF = keepIdx.map(i=>expenses[i])
      if(Array.isArray(baseline) && baseline.length===labels.length){
        baselineF = keepIdx.map(i=>baseline[i])
      }
      if(forecastFromIndex!=null){
        const firstForecastPos = keepIdx.findIndex(i=>i>=forecastFromIndex)
        forecastFromIndexF = firstForecastPos>=0 ? firstForecastPos : null
      }
    } else if(keepIdx.length===0){
      // –í—Å–µ —Ç–æ—á–∫–∏ –ø—É—Å—Ç—ã–µ ‚Äî –æ—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
      labelsF = []
      incomesF = []
      expensesF = []
      baselineF = null
      forecastFromIndexF = null
    }

    const lineValues = labelsF.map((_,i)=>{
      const inc = incomesF[i]||0, exp = expensesF[i]||0
      if(TX_FILTER==='income') return inc
      if(TX_FILTER==='expense') return -exp
      return inc - exp
    })
    return { labels: labelsF, incomes: incomesF, expenses: expensesF, lineValues, forecastFromIndex: forecastFromIndexF, baseline: baselineF }
  }

  const agg = aggregateForCharts()
  const barLabels = agg.labels
  let barIncomes = agg.incomes
  let barExpenses = agg.expenses
  const lineLabels = agg.labels
  const lineNets = agg.lineValues
  const baseline = agg.baseline

  const forecastOpts = agg.forecastFromIndex!=null?{forecastFrom: agg.forecastFromIndex}:{}
  const translucentSeries = ((window.UI && (UI.forecastMode==='avg12' || UI.forecastMode==='avg12both'))) ? { translucentSeriesIndices: (UI.forecastMode==='avg12both'?[0,1]:[0]) } : {}
  // Convert to display currency before drawing
  const barIncomesD = (barIncomes||[]).map(v=>convertValue(v))
  const barExpensesD = (barExpenses||[]).map(v=>convertValue(v))
  const lineNetsD = (lineNets||[]).map(v=>convertValue(v))
  const baselineD = Array.isArray(baseline) ? baseline.map(v=>convertValue(v)) : null
  drawBarChart($('#bar'), barLabels, [barIncomesD, barExpensesD], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'], Object.assign({}, forecastOpts, translucentSeries))
  drawLineChart($('#line'), lineLabels, lineNetsD, Object.assign({}, forecastOpts, baselineD?{baselineValues: baselineD}:{}))

  function drawPieChart(){
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    // –°—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    const totalByCat = {}
    const txForCats = filteredTransactionsWithoutCategory().filter(t => (t.amount||0) < 0)
    txForCats.forEach(t=>{
      const cat = t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
      totalByCat[cat] = (totalByCat[cat]||0) + Math.abs(t.amount||0)
    })
    const labels2=Object.keys(totalByCat)
    const vals=labels2.map(k=> convertValue(totalByCat[k]))
    drawDonutChart($('#pie'), labels2, vals)
  }
  
  drawPieChart() // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≥–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω)
  const periodControls = $('#periodControls')
  const monthControls = $('#monthControls')
  const yearControls = $('#yearControls')
  if(periodControls) periodControls.style.display = (PERIOD_FILTER.mode==='period') ? 'flex' : 'none'
  if(monthControls) monthControls.style.display = (PERIOD_FILTER.mode==='month') ? 'flex' : 'none'
  if(yearControls) yearControls.style.display = (PERIOD_FILTER.mode==='year') ? 'flex' : 'none'
  const seasonControls = $('#seasonControls')
  const weekControls = $('#weekControls')
  const dayControls = $('#dayControls')
  if(seasonControls) seasonControls.style.display = (PERIOD_FILTER.mode==='season') ? 'flex' : 'none'
  if(weekControls) weekControls.style.display = (PERIOD_FILTER.mode==='week') ? 'flex' : 'none'
  if(dayControls) dayControls.style.display = (PERIOD_FILTER.mode==='day') ? 'flex' : 'none'
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã
  $$('input[name="txFilter"]').forEach(radio => {
    radio.checked = radio.value === ((window.UI && UI.txFilter) ? UI.txFilter : TX_FILTER)
    radio.onchange = () => {
      window.UI = window.UI || {}
      UI.txFilter = radio.value
      TX_FILTER = radio.value
      updateAllCharts()
    }
  })
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ê–≥—Ä–µ–≥–∞—Ü–∏–∏
  $$('input[name="aggMode"]').forEach(radio => {
    radio.checked = radio.value === ((window.UI && UI.aggMode) ? UI.aggMode : 'month')
    radio.onchange = () => {
      window.UI = window.UI || {}
      UI.aggMode = radio.value
      updateAllCharts()
    }
  })
  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ü—Ä–æ–≥–Ω–æ–∑–∞
  $$('input[name="forecastMode"]').forEach(radio => {
    const current = (window.UI && (UI.forecastMode || (UI.forecast ? 'eoy' : 'off'))) || 'off'
    radio.checked = (radio.value === current)
    radio.onchange = () => {
      window.UI = window.UI || {}
      UI.forecastMode = radio.value
      UI.forecast = (radio.value === 'eoy')
      updateAllCharts()
    }
  })
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  function updateAllCharts(){
    const agg = aggregateForCharts()
    const barLabels = agg.labels
    let barIncomes = agg.incomes
    let barExpenses = agg.expenses
    const lineNets = agg.lineValues
    const forecastOpts = agg.forecastFromIndex!=null?{forecastFrom: agg.forecastFromIndex}:{}
    const translucentSeries = ((window.UI && (UI.forecastMode==='avg12' || UI.forecastMode==='avg12both'))) ? { translucentSeriesIndices: (UI.forecastMode==='avg12both'?[0,1]:[0]) } : {}
    // Convert to display currency before drawing
    const barIncomesD = (barIncomes||[]).map(v=>convertValue(v))
    const barExpensesD = (barExpenses||[]).map(v=>convertValue(v))
    const lineNetsD = (lineNets||[]).map(v=>convertValue(v))
    const baselineD = Array.isArray(agg.baseline) ? agg.baseline.map(v=>convertValue(v)) : null
    drawBarChart($('#bar'), barLabels, [barIncomesD, barExpensesD], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'], Object.assign({}, forecastOpts, translucentSeries))
    drawLineChart($('#line'), barLabels, lineNetsD, Object.assign({}, forecastOpts, baselineD?{baselineValues: baselineD}:{}))
    drawPieChart() // –ü–∏—Ä–æ–≥ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats()
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
    updateRecentOperationsTable()
  }
  // –°–¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ –∏–∑–≤–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤)
  window.updateAllCharts = updateAllCharts
  
  function updateStats(){
    const useForecast = !!(window.UI&&UI.forecast)
    const range = resolveSelectedRange()
    const kind = ((window.UI&&UI.aggMode)||'month')
    const buckets = generateBuckets(range, kind==='week'?'week':kind==='day'?'day':'month')
    const labels = buckets.map(b=>b.label)
    // –°—á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç –ø–æ –∫–æ—Ä–∑–∏–Ω–∞–º
    const tx = filteredTransactions()
    const sums = new Map()
    function keyOf(d){
      if(kind==='week') return isoWeekLabel(d)
      if(kind==='day') return formatISODate(d)
      return monthKey(d)
    }
    for(const t of tx){
      const d=new Date(t.date)
      const k=keyOf(d)
      const slot = sums.get(k)||{inc:0,exp:0}
      const a=+t.amount||0; if(a>=0) slot.inc+=a; else slot.exp+=-a
      sums.set(k,slot)
    }
    let incArr = labels.map(l=> (sums.get(l)?.inc||0))
    let expArr = labels.map(l=> (sums.get(l)?.exp||0))
    let forecastIdx = null
    let incForecastSum = 0, expForecastSum = 0
    if(useForecast && labels.length){
      const lastActualDate = tx.length ? new Date(Math.max(...tx.map(t=>+new Date(t.date)))) : new Date()
      forecastIdx = buckets.findIndex(b=> b.start > lastActualDate)
      if(forecastIdx>=0){
        const baseInc = incArr.slice(0,forecastIdx)
        const baseExp = expArr.slice(0,forecastIdx)
        const avgInc = baseInc.length ? baseInc.reduce((a,b)=>a+b,0)/baseInc.length : 0
        const avgExp = baseExp.length ? baseExp.reduce((a,b)=>a+b,0)/baseExp.length : 0
        for(let i=forecastIdx;i<labels.length;i++){ incArr[i]=avgInc; expArr[i]=avgExp; incForecastSum+=avgInc; expForecastSum+=avgExp }
      }
    }
    const factIncome = incArr.reduce((s,v,i)=> s + (forecastIdx!=null && i>=forecastIdx ? 0 : v), 0)
    const factExpense = expArr.reduce((s,v,i)=> s + (forecastIdx!=null && i>=forecastIdx ? 0 : v), 0)
    const totalIncome = factIncome + incForecastSum
    const totalExpense = factExpense + expForecastSum
    const totalNet = totalIncome - totalExpense
    const curr = STATE.vault.currency
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–æ–º–æ—â—å—é ID
    const incomeEl = $('#incomeValue')
    const expenseEl = $('#expenseValue')
    const netEl = $('#netValue')
    const netCard = netEl?.closest('.stat-card')
    
    if(incomeEl){
      if(useForecast && incForecastSum>0){
        incomeEl.innerHTML = `<span style="color:var(--ok)">${formatAmountDisplay(factIncome)}</span> + <span style=\"opacity:.55;color:var(--ok)\">${formatAmountDisplay(incForecastSum)}</span> = <span style=\"opacity:.55;color:var(--ok)\">${formatAmountDisplay(totalIncome)}</span>`
      }else{
        incomeEl.textContent = formatAmountDisplay(totalIncome)
      }
    }
    if(expenseEl){
      if(useForecast && expForecastSum>0){
        expenseEl.innerHTML = `<span style="color:var(--danger)">${formatAmountDisplay(factExpense)}</span> + <span style=\"opacity:.55;color:var(--danger)\">${formatAmountDisplay(expForecastSum)}</span> = <span style=\"opacity:.55;color:var(--danger)\">${formatAmountDisplay(totalExpense)}</span>`
      }else{
        expenseEl.textContent = formatAmountDisplay(totalExpense)
      }
    }
    if(netEl) {
      if(useForecast && (incForecastSum>0 || expForecastSum>0)){
        const netFact = factIncome - factExpense
        const netForecast = incForecastSum - expForecastSum
        const netFactColor = netFact>=0?'var(--ok)':'var(--danger)'
        const netForecastColor = netForecast>=0?'var(--ok)':'var(--danger)'
        const netSumColor = totalNet>=0?'var(--ok)':'var(--danger)'
        netEl.innerHTML = `<span style="color:${netFactColor}">${formatAmountDisplay(netFact)}</span> + <span style=\"opacity:.55;color:${netForecastColor}\">${formatAmountDisplay(netForecast)}</span> = <span style=\"opacity:.55;color:${netSumColor}\">${formatAmountDisplay(totalNet)}</span>`
      }else{
        netEl.textContent = formatAmountDisplay(totalNet)
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
      if(netCard) {
        netCard.classList.remove('positive', 'negative')
        netCard.classList.add(totalNet >= 0 ? 'positive' : 'negative')
      }
    }
  }
  
  function updateRecentOperationsTable(){
    const allSearched = getFilteredAndSearchedTransactions()
    const recent = allSearched.slice(0, RECENT_LIMIT)
    const curr = STATE.vault.currency
    const tbody = $('#main .table-scroll tbody')
    if(tbody) {
      tbody.innerHTML = recent.map(t=>`<tr title="${(()=>{const a=[]; if(t.trName) a.push('TR_NAME: '+escapeHtml(t.trName)); if(t.nameR) a.push('NAME_R: '+escapeHtml(t.nameR)); if(t.remI) a.push('REM_I: '+escapeHtml(t.remI)); if(t.remII) a.push('REM_II: '+escapeHtml(t.remII)); return a.join('\\n');})()}"><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${t.category?`<button class=\"btn-small\" title=\"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat-cat=\"${escapeHtml(t.category)}\">‚úé</button> ${escapeHtml(t.category)}`:`<button class=\"btn-small\" title=\"–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat=\"${t.id}\">‚úé</button>`}</td><td style=\"text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}\">${formatAmountDisplay(t.amount)}</td><td style=\"width:32px;text-align:right;\">${t.source==='manual'?`<button class=\"btn-small\" data-del-tx=\"${t.id}\">üóë</button>`:''}</td></tr>`).join('')
        // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        $$('[data-del-tx]', tbody).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
        // –ò–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        $$('[data-edit-cat]', tbody).forEach(b=>{ b.onclick=()=> openQuickCategoryDialog(b.getAttribute('data-edit-cat')) })
        // –ö–∞—Ä–∞–Ω–¥–∞—à —Ä—è–¥–æ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π: –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –ø—Ä–µ–¥–≤—ã–±–æ—Ä–æ–º
        $$('[data-edit-cat-cat]', tbody).forEach(b=>{ b.onclick=()=>{ const cat=b.getAttribute('data-edit-cat-cat'); if(typeof openCategoriesModal==='function'){ openCategoriesModal(cat) } } })
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ "–∏–∑ y"
        const totalEl = $('#recentTotalCount')
        if(totalEl) totalEl.textContent = String(allSearched.length)
    }
  }

  // –†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
  $$('input[name="filterMode"]').forEach(radio => {
    radio.onchange = () => {
      PERIOD_FILTER.mode = radio.value
      const periodControls = $('#periodControls')
      const monthControls = $('#monthControls')
      const yearControls = $('#yearControls')
      const seasonControls = $('#seasonControls')
      const weekControls = $('#weekControls')
      const dayControls = $('#dayControls')
      
      if(radio.value === 'period') {
        periodControls.style.display = 'flex'
        monthControls.style.display = 'none'
        yearControls.style.display = 'none'
        if(seasonControls) seasonControls.style.display='none'
        if(weekControls) weekControls.style.display='none'
        if(dayControls) dayControls.style.display='none'
      } else if(radio.value === 'month') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'flex'
        yearControls.style.display = 'none'
        if(seasonControls) seasonControls.style.display='none'
        if(weekControls) weekControls.style.display='none'
        if(dayControls) dayControls.style.display='none'
      } else if(radio.value === 'year') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'none'
        yearControls.style.display = 'flex'
        if(seasonControls) seasonControls.style.display='none'
        if(weekControls) weekControls.style.display='none'
        if(dayControls) dayControls.style.display='none'
      } else if(radio.value === 'season') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'none'
        yearControls.style.display = 'none'
        if(seasonControls) seasonControls.style.display='flex'
        if(weekControls) weekControls.style.display='none'
        if(dayControls) dayControls.style.display='none'
      } else if(radio.value === 'week') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'none'
        yearControls.style.display = 'none'
        if(seasonControls) seasonControls.style.display='none'
        if(weekControls) weekControls.style.display='flex'
        if(dayControls) dayControls.style.display='none'
      } else if(radio.value === 'day') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'none'
        yearControls.style.display = 'none'
        if(seasonControls) seasonControls.style.display='none'
        if(weekControls) weekControls.style.display='none'
        if(dayControls) dayControls.style.display='flex'
      }
      updateAllCharts()
    }
  })

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ (–æ—Ç/–¥–æ)
  const globalFromMonth = $('#globalFromMonth')
  const globalToMonth = $('#globalToMonth')
  if(globalFromMonth) globalFromMonth.onchange = () => {
    PERIOD_FILTER.fromMonth = globalFromMonth.value
    updateAllCharts()
  }
  if(globalToMonth) globalToMonth.onchange = () => {
    PERIOD_FILTER.toMonth = globalToMonth.value
    updateAllCharts()
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
  const globalSingleMonth = $('#globalSingleMonth')
  if(globalSingleMonth) globalSingleMonth.onchange = () => {
    PERIOD_FILTER.singleMonth = globalSingleMonth.value
    updateAllCharts()
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–¥–∞
  const globalYear = $('#globalYear')
  if(globalYear){
    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª–µ—Ç
    const {months} = monthBuckets()
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    globalYear.innerHTML = years.map(y=>`<option ${y===PERIOD_FILTER.singleYear?'selected':''}>${y}</option>`).join('')
    globalYear.onchange = () => {
      PERIOD_FILTER.singleYear = globalYear.value
      updateAllCharts()
    }
  }

  // –ö–≤–∞—Ä—Ç–∞–ª: –≥–æ–¥ + –∫–≤–∞—Ä—Ç–∞–ª
  const quarterYear = $('#quarterYear')
  const quarterSelect = $('#quarterSelect')
  // –°–µ–∑–æ–Ω –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä "YYYY –°–µ–∑–æ–Ω"
  const seasonCombined = $('#seasonCombined')
  if(seasonCombined){
    const {months} = monthBuckets()
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    const seasons = [
      {key:'spring', label:'–í–µ—Å–Ω–∞'},
      {key:'summer', label:'–õ–µ—Ç–æ'},
      {key:'autumn', label:'–û—Å–µ–Ω—å'},
      {key:'winter', label:'–ó–∏–º–∞'}
    ]
    const makeVal = (y,s) => `${y}:${s}`
    const currentVal = makeVal(PERIOD_FILTER.singleYear||years[years.length-1], PERIOD_FILTER.singleSeason||'spring')
    seasonCombined.innerHTML = years.map(y=> seasons.map(s=>`<option value="${makeVal(y,s.key)}" ${currentVal===makeVal(y,s.key)?'selected':''}>${y} ${s.label}</option>`).join('')).join('')
    seasonCombined.onchange = () => {
      const [y,s] = String(seasonCombined.value||'').split(':')
      PERIOD_FILTER.singleYear = y
      PERIOD_FILTER.singleSeason = s||'spring'
      updateAllCharts()
    }
  }

  // –ù–µ–¥–µ–ª–∏: –≥–æ–¥ + –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ (ISO)
  const weekYearSel = $('#weekYear')
  const weekNumberSel = $('#weekNumber')
  if(weekYearSel){
    const {months} = monthBuckets()
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    const curYear = PERIOD_FILTER.weekYear || PERIOD_FILTER.singleYear || years[years.length-1]
    weekYearSel.innerHTML = years.map(y=>`<option ${String(y)===String(curYear)?'selected':''}>${y}</option>`).join('')
    weekYearSel.onchange = () => { PERIOD_FILTER.weekYear = weekYearSel.value; populateWeekNumbers(); updateAllCharts() }
  }
  function populateWeekNumbers(){
    if(!weekNumberSel) return
    const y = Number(PERIOD_FILTER.weekYear || new Date().getFullYear())
    const maxWeeks = 53
    const current = PERIOD_FILTER.weekNumber || 1
    weekNumberSel.innerHTML = Array.from({length:maxWeeks}, (_,i)=>i+1).map(w=>`<option value="${w}" ${Number(current)===w?'selected':''}>W${String(w).padStart(2,'0')}</option>`).join('')
    weekNumberSel.onchange = () => { PERIOD_FILTER.weekNumber = parseInt(weekNumberSel.value)||1; updateAllCharts() }
  }
  if(weekNumberSel){ populateWeekNumbers() }

  // –î–µ–Ω—å: –≥–æ–¥ + –º–µ—Å—è—Ü + –¥–µ–Ω—å
  const dayYearSel = $('#dayYear')
  const dayMonthSel = $('#dayMonth')
  const dayDaySel = $('#dayDay')
  if(dayYearSel){
    const {months} = monthBuckets()
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    const curY = PERIOD_FILTER.dayYear || PERIOD_FILTER.singleYear || years[years.length-1]
    dayYearSel.innerHTML = years.map(y=>`<option ${String(y)===String(curY)?'selected':''}>${y}</option>`).join('')
    dayYearSel.onchange = () => { PERIOD_FILTER.dayYear = dayYearSel.value; populateDayMonths(); populateDayDays(); updateAllCharts() }
  }
  function populateDayMonths(){
    if(!dayMonthSel) return
    const curM = Number(PERIOD_FILTER.dayMonth || new Date().getMonth()+1)
    dayMonthSel.innerHTML = Array.from({length:12},(_,i)=>i+1).map(m=>`<option value="${m}" ${curM===m?'selected':''}>${String(m).padStart(2,'0')}</option>`).join('')
    dayMonthSel.onchange = () => { PERIOD_FILTER.dayMonth = parseInt(dayMonthSel.value)||1; populateDayDays(); updateAllCharts() }
  }
  function populateDayDays(){
    if(!dayDaySel) return
    const y = Number(PERIOD_FILTER.dayYear || new Date().getFullYear())
    const m = Number(PERIOD_FILTER.dayMonth || new Date().getMonth()+1)
    const dim = daysInMonth(y, m-1)
    const curD = Number(PERIOD_FILTER.dayDay || 1)
    dayDaySel.innerHTML = Array.from({length:dim},(_,i)=>i+1).map(d=>`<option value="${d}" ${curD===d?'selected':''}>${String(d).padStart(2,'0')}</option>`).join('')
    dayDaySel.onchange = () => { PERIOD_FILTER.dayDay = parseInt(dayDaySel.value)||1; updateAllCharts() }
  }
  if(dayMonthSel){ populateDayMonths() }
  if(dayDaySel){ populateDayDays() }

  const btn=$('#btnOpenAdd'); if(btn) btn.onclick=openAddModal
  const btnCats=$('#btnOpenCats'); if(btnCats) btnCats.onclick=openCategoriesModal
  const btnStmt=$('#btnOpenStmt'); if(btnStmt) btnStmt.onclick=openStatementsModal
  const btnDemo=$('#btnDemo'); if(btnDemo){
    let DEMO_ACTIVE = !!(window.UI && UI.demoActive)
    const setDemoUi=(active)=>{
      DEMO_ACTIVE = !!active
      window.UI = window.UI || {}
      UI.demoActive = DEMO_ACTIVE
      btnDemo.textContent = active ? '‚èπ' : '‚ñ∂'
      btnDemo.title = active ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ'
      btnDemo.classList.toggle('active', active)
      btnDemo.classList.remove('demo-play','demo-stop')
      btnDemo.classList.add(active ? 'demo-stop' : 'demo-play')
    }
    setDemoUi(DEMO_ACTIVE)
    btnDemo.onclick = async ()=>{
      try{
        if(!DEMO_ACTIVE){
          if(!confirm('–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ? –ë—É–¥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–∏—Å–æ–∫ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ –ø–∞–ø–∫–∏ demo. –¢–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –¥–µ–º–æ-–Ω–∞–±–æ—Ä–æ–º.')) return

          async function loadJsonWithFallback(url, embeddedId){
            try{
              const res = await fetch(url, {cache:'no-store'})
              if(!res.ok) throw new Error('HTTP '+res.status)
              return await res.json()
            }catch(_){
              try{
                if(embeddedId==='demoVaultEmbedded' && window.DEMO_VAULT){ return window.DEMO_VAULT }
                if(embeddedId==='demoCatsEmbedded' && window.DEMO_CATS){ return window.DEMO_CATS }
              }catch(_2){ }
              return null
            }
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –¥–µ–º–æ (–æ–¥–∏–Ω —Ä–∞–∑)
          try{
            if(localStorage.getItem(DEMO_BACKUP_KEY)===null){
              const prev = localStorage.getItem(LS_KEY)
              localStorage.setItem(DEMO_BACKUP_KEY, prev!==null ? prev : '')
            }
          }catch(_){ }

          const [demoVaultRaw, demoCats] = await Promise.all([
            loadJsonWithFallback('demo/ofb-vault-demo.json','demoVaultEmbedded'),
            loadJsonWithFallback('demo/ofb-categories-demo.json','demoCatsEmbedded')
          ])
          const demoVault = ensureVault(demoVaultRaw||emptyVault())
          if(!demoVaultRaw){ toast('–ó–∞–≥—Ä—É–∂–∞—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ (file:// —Ä–µ–∂–∏–º)','warn') }
          if(!demoCats){ toast('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (demo) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞','warn') }
          STATE = {unlocked:true, pass:null, vault: emptyVault()}
          STATE.vault.currency = demoVault.currency||'BGN'
          STATE.vault.transactions = Array.isArray(demoVault.transactions)
            ? demoVault.transactions.map(t=>{
                const nt = normalizeImportedTx(t)
                if(nt && nt.desc){ nt.desc = String(nt.desc).replace(/MICROSOFT BULGARIA EOOD|GOOGLE BULGARIA EOOD/gi,'GOOGLE') }
                return nt
              })
            : []
          STATE.vault.adjustments = demoVault.adjustments||{}
          STATE.vault.categories = Array.isArray(demoCats?.categories)? demoCats.categories : (demoVault.categories||[])
          STATE.vault.catRules = Array.isArray(demoCats?.catRules)? demoCats.catRules : (demoVault.catRules||[])
          applyCatRulesToAllTransactions()
          if(STATE.vault.transactions.length){
            const dates = STATE.vault.transactions.map(t=>t.date).sort()
            const firstDate = new Date(dates[0])
            const lastDate = new Date(dates[dates.length-1])
            PERIOD_FILTER.fromMonth = monthKey(firstDate)
            PERIOD_FILTER.toMonth = monthKey(lastDate)
            PERIOD_FILTER.singleMonth = monthKey(lastDate)
            PERIOD_FILTER.singleYear = String(lastDate.getFullYear())
          }
          await saveVault(); window.UI=window.UI||{}; UI.demoActive=true; render(); toast('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ')
        } else {
          if(!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–º–æ? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã.')) return
          try{ localStorage.removeItem(LS_KEY) }catch(_){ }
          try{ localStorage.removeItem(DEMO_BACKUP_KEY) }catch(_){ }
          STATE = {unlocked:true, pass:null, vault: emptyVault()}
          window.UI=window.UI||{}; UI.demoActive=false; render(); toast('–î–µ–º–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã')
        }
      }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é –¥–µ–º–æ','warn') }
    }
  }
  const btnClr2=$('#btnClearStorage2'); if(btnClr2){ btnClr2.onclick = ()=> $('#btnClearStorage')?.click() }
  $$('[data-expand]').forEach(b=>{ b.onclick=()=>{ openExpanded(b.getAttribute('data-expand')) } })
  $$('[data-del-tx]').forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –æ–ø–µ—Ä–∞—Ü–∏–π
  const recentLimitInput = $('#recentLimit')
  const catFilterSel = $('#catFilterGlobal')
  const searchInput = $('#searchInput')
  
  if(recentLimitInput) {
    recentLimitInput.oninput = () => {
      const newLimit = parseInt(recentLimitInput.value) || 7
      if(newLimit >= 1 && newLimit <= 50) {
        RECENT_LIMIT = newLimit
        updateRecentOperationsTable()
      }
    }
  }
  if(catFilterSel){
    catFilterSel.onchange = () => { CAT_FILTER = catFilterSel.value; updateRecentOperationsTable(); drawPieChart(); updateAllCharts(); }
  }
  
  if(searchInput) {
    searchInput.oninput = () => {
      SEARCH_TEXT = searchInput.value
      updateRecentOperationsTable()
    }
  }
  const overlay=$('#dashOverlay'); if(overlay){ overlay.onclick=closeExpanded }
  const closeBtn=$('#btnCloseDashModal'); if(closeBtn){ closeBtn.onclick=closeExpanded }
  if(window.UI&&UI.expanded){ renderExpanded(UI.expanded) } else { hideExpanded() }

  // –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JSON –æ–ø–∏—Å–∞–Ω–∏–π
  $$('[data-copy-desc]').forEach(btn=>{ btn.onclick = copyDescriptionsJSON })

  // –ò–Ω–ª–∞–π–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö
  $$('[data-edit-cat]').forEach(btn=>{ btn.onclick = ()=> openQuickCategoryDialog(btn.getAttribute('data-edit-cat')) })
  // –ö–∞—Ä–∞–Ω–¥–∞—à —Ä—è–¥–æ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π: –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –ø—Ä–µ–¥–≤—ã–±–æ—Ä–æ–º
  $$('[data-edit-cat-cat]').forEach(btn=>{ btn.onclick = ()=>{ const cat = btn.getAttribute('data-edit-cat-cat'); if(typeof openCategoriesModal==='function'){ openCategoriesModal(cat) } } })
}

function openStatementsModal(){
  const o=$('#dashOverlay'), m=$('#dashModal'), t=$('#dashModalTitle'), c=$('#dashModalContent')
  if(!o||!m||!t||!c) return
  o.style.display='block'; m.style.display='block'
  c.innerHTML = ''
  if(t){ t.textContent = '–í—ã–ø–∏—Å–∫–∏ (XML/JSON)'; const rs=t.parentElement?.querySelector('.right'); if(rs) rs.innerHTML='' }
  c.innerHTML = sideUI()
  bindSide()
}

function openQuickCategoryDialog(txId){
  const tx = STATE.vault.transactions.find(t=>t.id===txId)
  if(!tx){ toast('–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','warn'); return }
  const wrap=document.createElement('div')
  wrap.style.position='fixed';wrap.style.inset='0';wrap.style.display='flex';wrap.style.alignItems='center';wrap.style.justifyContent='center';wrap.style.background='rgba(0,0,0,0.5)';wrap.style.zIndex='9998'
  const cats = STATE?.vault?.categories || []
  wrap.innerHTML = `<div class="card" style="width:min(420px,95vw)">
    <h3 style="margin:0 0 10px 0">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
    <div class="grid-sm">
      <div>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="qcCat" class="filter-select">${['<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>'].concat(cats.map(c=>`<option ${tx.category===c?'selected':''} value="${c}">${c}</option>`)).join('')}</select>
      </div>
      <div>
        <label>–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞</label>
        <input id="qcMatch" type="text" value="${escapeHtml(tx.desc||'')}" placeholder="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ"/>
        <div class="help">–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏; –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞.</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="inline"><button id="qcSave" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="qcCancel" class="btn">–û—Ç–º–µ–Ω–∞</button></div>
  </div>`
  document.body.appendChild(wrap)
  $('#qcCancel', wrap).onclick=()=>wrap.remove()
  $('#qcSave', wrap).onclick=async ()=>{
    const cat = $('#qcCat', wrap).value
    const match = String($('#qcMatch', wrap).value||'').trim()
    if(!cat){ toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é','warn'); return }
    // –û–±–Ω–æ–≤–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    tx.category = cat
    // –î–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–æ, –µ—Å–ª–∏ match —É–∫–∞–∑–∞–Ω
    if(match){
      STATE.vault.catRules = (STATE.vault.catRules||[]).concat([{id:uid(), match, category:cat}])
      // –ü—Ä–∏–º–µ–Ω–∏–º –ø—Ä–∞–≤–∏–ª–∞ —Å—Ä–∞–∑—É
      applyCatRulesToAllTransactions()
    }
    await saveVault(); render(); wrap.remove(); toast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∞')
  }
}

async function copyDescriptionsJSON(){
  try{
    const data = getFilteredAndSearchedTransactions().map(t=>({
      desc: t.desc||'',
      trName: t.trName||null,
      nameR: t.nameR||null,
      remI: t.remI||null,
      remII: t.remII||null
    }))
    await navigator.clipboard.writeText(JSON.stringify(data, null, 2))
    toast('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')
  }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','warn') }
}

function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}

function bindUnlock(){
  $('#btnUnlock').onclick = async ()=>{
    const pass = $('#pass').value.trim()
    if(pass.length<8){toast('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π','warn');return}
    const bundle = loadBundle()
    if(bundle){
      try{
        const vault = await decryptJSON(bundle, pass)
        STATE={unlocked:true,pass,vault}
        toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ')
        render()
      }catch(e){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ','warn') }
    }else{
      STATE={unlocked:true,pass,vault:emptyVault()}
      await saveVault(); render()
    }
  }
  $('#restoreFile').onchange = async (e)=>{
    const file=e.target.files[0]; if(!file) return
    const text=await file.text()
    try{ JSON.parse(text); localStorage.setItem(LS_KEY,text); toast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –¢–µ–ø–µ—Ä—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ.','success') }
    catch(err){ toast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏','warn') }
  }
}

function bindSide(){
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ
  const exportBtn = $('#btnExportVault');
  if(exportBtn){
    exportBtn.onclick=()=>{
      const data = localStorage.getItem(LS_KEY)
      if(!data){toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','warn');return}
      download(`ofb-vault-${new Date().toISOString().slice(0,10)}.json`, data)
    }
  }
  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤–Ω—É—Ç—Ä—å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const btnOpenCats2=$('#btnOpenCats2'); if(btnOpenCats2) btnOpenCats2.onclick=openCategoriesModal
  // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–æ–∫ (XML/JSON)
  const btnDoImp = $('#btnDoImportStmt'); if(btnDoImp) btnDoImp.onclick = doImportStmt
  const btnClr = $('#btnClearStmt'); if(btnClr) btnClr.onclick = () => { clearFile('stmtFile'); clearStmtSelection(); toast('–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –æ—á–∏—â–µ–Ω'); }
  const dz = $('#stmtDropzone')
  if(dz){
    ;['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault(); dz.classList.add('drag')}))
    ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault(); dz.classList.remove('drag')}))
    dz.addEventListener('drop', async (e)=>{ const f=e.dataTransfer.files?.[0]; if(f){ $('#stmtFile').files = e.dataTransfer.files; await onStmtChosen() } })
  }
  // CSV –æ—Ç–∫–ª—é—á—ë–Ω
}

// CSV –∏–º–ø–æ—Ä—Ç —É–¥–∞–ª—ë–Ω

// ===== –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ô –ò–ú–ü–û–†–¢ –í–´–ü–ò–°–û–ö (XML/JSON) =====
let PENDING_IMPORT=null // { kind: 'xml'|'json', text: string, preview: {count, firstDate, lastDate, currency?} }

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è HTML onchange
window.onStmtChosen = async function(event) {
  try{
    const inp = event ? event.target : $('#stmtFile'); 
    if (!inp) { 
      toast('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input stmtFile','warn'); 
      return;
    }
    const file = inp.files && inp.files[0]; 
    if (!file) {
      clearStmtSelection();
      return;
    }
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const infoWrapEl = $('#stmtFileInfo');
    const fileNameEl = $('#stmtFileName');
    const infoEl = $('#stmtInfo');
    const statusEl = $('#stmtStatus');
    // Fallback –µ—Å–ª–∏ readFileTextSmart –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
    if (typeof readFileTextSmart !== 'function') {
      const readFileTextSmart = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(e);
          reader.readAsText(file, 'UTF-8');
        });
      };
      window.readFileTextSmart = readFileTextSmart;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    if (infoWrapEl) {
      infoWrapEl.style.display = 'block';
    }
    if (fileNameEl) {
      // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
      const truncateFileName = (name, maxLength = 20) => {
        return name.length > maxLength ? name.substring(0, maxLength) + '...' : name;
      };
      fileNameEl.textContent = `${truncateFileName(file.name)} (${(file.size/1024).toFixed(1)} KB)`;
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ title –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      fileNameEl.title = file.name;
    }
    if (statusEl) {
      statusEl.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
      statusEl.style.color = 'var(--muted)';
    }
    // –ß–∏—Ç–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º —Ñ–∞–π–ª
    const text = await readFileTextSmart(file); 
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    const isXml = /xml$/.test(ext) || /xml/i.test(file.type||'')
    let info
    if(isXml){
      info = previewXml(text)
      PENDING_IMPORT = { kind:'xml', text, preview: info }
    }else{
      info = previewVaultJson(text)
      PENDING_IMPORT = info && info.count>0 ? { kind:'json', text, preview: info } : null
    }
    if (PENDING_IMPORT && PENDING_IMPORT.preview && PENDING_IMPORT.preview.count>0) {
      const p = PENDING_IMPORT.preview
      const infoText = `${p.count} –æ–ø–µ—Ä–∞—Ü–∏–π ¬∑ ${p.firstDate} ‚Äî ${p.lastDate}${p.currency ? ` ¬∑ ${p.currency}` : ''}`;
      if (infoEl) {
        infoEl.textContent = infoText;
        infoEl.style.color = 'var(--accent)';
      }
      if (statusEl) {
        statusEl.textContent = '–ì–æ—Ç–æ–≤ –∫ –∏–º–ø–æ—Ä—Ç—É';
        statusEl.style.color = 'var(--ok)';
      }
      enableImportButtons();
    } else {
      if (infoEl) {
        infoEl.textContent = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ';
        infoEl.style.color = 'var(--warn)';
      }
      if (statusEl) {
        statusEl.textContent = '–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π';
        statusEl.style.color = 'var(--warn)';
      }
      disableImportButtons();
    }
  } catch(e) { 
    toast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: ' + e.message, 'warn');
    const infoWrapEl = $('#stmtFileInfo');
    const statusEl = $('#stmtStatus');
    if (infoWrapEl) {
      infoWrapEl.style.display = 'block';
    }
    if (statusEl) {
      statusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
      statusEl.style.color = 'var(--danger)';
    }
    disableImportButtons();
  }
};
// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–º–ø–æ—Ä—Ç–∞
function enableImportButtons() {
  const importBtn = $('#btnDoImportStmt');
  const clearBtn = $('#btnClearStmt');
  if (importBtn) {
    importBtn.disabled = false;
    importBtn.style.opacity = '1';
  }
  if (clearBtn) {
    clearBtn.disabled = false;
    clearBtn.style.opacity = '1';
  }
}

function disableImportButtons() {
  const importBtn = $('#btnDoImportStmt');
  const clearBtn = $('#btnClearStmt');
  if (importBtn) {
    importBtn.disabled = true;
    importBtn.style.opacity = '0.5';
  }
  if (clearBtn) {
    clearBtn.disabled = true;
    clearBtn.style.opacity = '0.5';
  }
}

function clearStmtSelection() {
  PENDING_IMPORT = null;
  
  const infoWrapEl = $('#stmtFileInfo');
  if (infoWrapEl) {
    infoWrapEl.style.display = 'none';
  }
  
  // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
  const elements = ['#stmtFileName', '#stmtInfo', '#stmtStatus'];
  elements.forEach(sel => {
    const el = $(sel);
    if (el) el.textContent = '';
  });
  
  disableImportButtons();
}

async function doImportStmt(){
  if(!PENDING_IMPORT){ 
    toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'warn'); 
    return;
  }
  // –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞: merge –∏–ª–∏ replace
  const mode = await confirmImportMode()
  if(!mode){ return }
  try{
    const statusEl = $('#stmtStatus');
    if (statusEl) { statusEl.textContent = '–ò–º–ø–æ—Ä—Ç...'; statusEl.style.color = 'var(--primary)'; }
    let imported = []
    let importedCurrency = null
    if(PENDING_IMPORT.kind==='xml'){
      const res = parseXmlTransactions(PENDING_IMPORT.text)
      imported = res.transactions||[]
      importedCurrency = res.currency||null
    }else if(PENDING_IMPORT.kind==='json'){
      const v = ensureVault(JSON.parse(PENDING_IMPORT.text))
      imported = Array.isArray(v.transactions)? v.transactions : []
      importedCurrency = v.currency||null
    }
    if(!imported.length){ toast('–í —Ñ–∞–π–ª–µ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π','warn'); return }
    if(mode==='replace'){
      const preservedCats = (STATE?.vault?.categories)||[]
      const preservedRules = (STATE?.vault?.catRules)||[]
      resetBeforeImport('vault')
      STATE.vault.transactions = []
      addTransactions(imported.map(t=>normalizeImportedTx(t)))
      if(Array.isArray(preservedCats) && preservedCats.length) STATE.vault.categories = preservedCats
      if(Array.isArray(preservedRules) && preservedRules.length) STATE.vault.catRules = preservedRules
      if(importedCurrency){ STATE.vault.currency = importedCurrency }
      applyCatRulesToAllTransactions()
      if(imported.length>0){
        const dates = imported.map(t=>t.date).sort()
        const firstDate = new Date(dates[0])
        const lastDate = new Date(dates[dates.length-1])
        PERIOD_FILTER.fromMonth = monthKey(firstDate)
        PERIOD_FILTER.toMonth = monthKey(lastDate)
        PERIOD_FILTER.singleMonth = monthKey(lastDate)
      }
    }else{
      // merge
      const added = mergeTransactionsIntoVault(imported.map(t=>normalizeImportedTx(t)))
      // –í–∞–ª—é—Ç—É –Ω–µ –º–µ–Ω—è–µ–º –ø—Ä–∏ –º–µ—Ä–¥–∂–µ
      applyCatRulesToAllTransactions()
      toast(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${added} –Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–º–µ—Ä–¥–∂)`)    
    }
    await saveVault();
    render();
    // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
    clearFile('stmtFile');
    clearStmtSelection();
    toast(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${imported.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);
  }catch(err){
    toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message, 'warn')
    const statusEl = $('#stmtStatus');
    if (statusEl) {
      statusEl.textContent = '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message;
      statusEl.style.color = 'var(--danger)';
    }
  }
}

function normalizeImportedTx(t){
  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ö–µ–º—É –∏ –Ω–æ–≤—ã–µ id –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  return {
    id: t.id && String(t.id).length>4 ? String(t.id) : uid(),
    date: (t.date && String(t.date).slice(0,10)) || new Date().toISOString().slice(0,10),
    desc: String(t.desc||'').trim(),
    amount: +t.amount || 0,
    category: t.category ? String(t.category) : null,
    source: t.source==='manual' ? 'manual' : 'import',
    trName: t.trName||null,
    nameR: t.nameR||null,
    remI: t.remI||null,
    remII: t.remII||null
  }
}

function mergeTransactionsIntoVault(incoming){
  const keyOf = (tx) => {
    const d = String(tx.date||'').slice(0,10)
    const a = (Math.round((+tx.amount||0)*100)/100).toFixed(2)
    const desc = String(tx.desc||'').trim().toLowerCase()
    return `${d}|${a}|${desc}`
  }
  const existingKeys = new Set(STATE.vault.transactions.map(keyOf))
  let added=0
  for(const t of incoming){
    const k = keyOf(t)
    if(existingKeys.has(k)) continue
    STATE.vault.transactions.push(t)
    existingKeys.add(k)
    added++
  }
  return added
}

function previewVaultJson(jsonText){
  try{
    const v = ensureVault(JSON.parse(jsonText))
    const tx = Array.isArray(v.transactions)? v.transactions : []
    if(!tx.length) return {count:0}
    const dates = tx.map(t=>new Date(t.date))
    const firstDate = dateFmt.format(new Date(Math.min(...dates)))
    const lastDate = dateFmt.format(new Date(Math.max(...dates)))
    return {count:tx.length, firstDate, lastDate, currency: v.currency||null}
  }catch(_){ return {count:0} }
}

// –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–º–ø–æ—Ä—Ç–∞
function confirmImportMode(){
  return new Promise(resolve=>{
    const wrap=document.createElement('div')
    wrap.style.position='fixed';wrap.style.inset='0';wrap.style.display='flex';wrap.style.alignItems='center';wrap.style.justifyContent='center';wrap.style.background='rgba(0,0,0,0.5)';wrap.style.zIndex='9998'
    wrap.innerHTML = `<div class="card" style="width:min(520px,95vw)">
      <h3 style="margin:0 0 8px 0">–ò–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–∫–∏</h3>
      <div class="help" style="margin-bottom:8px">
        –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: <b>–º–µ—Ä–¥–∂–∏—Ç—å</b> –¥–æ–±–∞–≤–∏—Ç –Ω–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤–∞—à–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ä—É—á–Ω—ã–µ –∑–∞–ø–∏—Å–∏. <b>–ó–∞–º–µ–Ω–∏—Ç—å</b> ‚Äî –æ—á–∏—Å—Ç–∏—Ç —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç –∏–∑ —Ñ–∞–π–ª–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è).
      </div>
      <div class="inline">
        <button id="impMerge" class="btn">–ú–µ—Ä–¥–∂–∏—Ç—å</button>
        <button id="impReplace" class="warn">–ó–∞–º–µ–Ω–∏—Ç—å</button>
        <span class="right"></span>
        <button id="impCancel" class="btn">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>`
    document.body.appendChild(wrap)
    const done=(v)=>{ try{wrap.remove()}catch(_){ }; resolve(v) }
    $('#impMerge',wrap).onclick=()=>done('merge')
    $('#impReplace',wrap).onclick=()=>{ if(confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.')) done('replace') }
    $('#impCancel',wrap).onclick=()=>done(null)
    wrap.addEventListener('click',(e)=>{ if(e.target===wrap) done(null) })
    window.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ done(null); window.removeEventListener('keydown', esc) } })
  })
}
function previewXml(xmlText){
  try{
    const {transactions,currency} = parseXmlTransactions(xmlText)
    if(!transactions || !transactions.length) {
      return {count:0}
    }
    
    const dates = transactions.map(t=>new Date(t.date))
    const firstDate = dateFmt.format(new Date(Math.min(...dates)))
    const lastDate = dateFmt.format(new Date(Math.max(...dates)))
    return {count:transactions.length, firstDate, lastDate, currency}
  } catch(e) { 
    return {count:0} 
  }
}
// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ–º–∞–Ω–Ω—ã—Ö XML (TRANSACTION)
// Normalization START
function normalizeBrokenXmlIfNeeded(doc){
  try{
    const A=(x)=>Array.from(x||[]);
    const EQ=(a,b)=>String(a||'').toUpperCase()===String(b||'').toUpperCase();
    const child=(n,t)=>A(n.children).find(el=>EQ(el.tagName,t))||null;
    const text=(n,t)=>{const el=child(n,t);return el&&el.textContent?el.textContent.trim():''};
    const set=(tx,t,v)=>{let el=child(tx,t);if(!el){el=doc.createElement(t);tx.appendChild(el)}el.textContent=String(v==null?'':v).trim();return el};
    const rmByRx=(tx,rx)=>{A(tx.children).forEach(el=>{if(rx.test(el.tagName)) tx.removeChild(el)})};
    const insAfter=(p,el,ref)=>{if(!ref){p.appendChild(el);return}const n=ref.nextSibling;n?p.insertBefore(el,n):p.appendChild(el)};

    const txs=[].concat(A(doc.getElementsByTagName('TRANSACTION')),A(doc.getElementsByTagName('transaction')));
    if(!txs.length) return;

    const isBroken=(tx)=>{
      const kids=A(tx.children);
      const iD=kids.findIndex(el=>/^(AMOUNT_D|DEBITAMOUNT)$/i.test(el.tagName));
      const iC=kids.findIndex(el=>/^(AMOUNT_C|CREDITAMOUNT)$/i.test(el.tagName));
      const hD=iD>=0,hC=iC>=0;
      return (hD&&hC)||(!hD&&!hC);
    };

    const fileBroken=txs.some(isBroken);
    if(!fileBroken) return;

    for(const tx of txs){
      if(!isBroken(tx)) continue;

      const kids=A(tx.children);
      const iD=kids.findIndex(el=>/^(AMOUNT_D|DEBITAMOUNT)$/i.test(el.tagName));
      const iC=kids.findIndex(el=>/^(AMOUNT_C|CREDITAMOUNT)$/i.test(el.tagName));
      const hD=iD>=0,hC=iC>=0;

      const origREM_I=text(tx,'REM_I');
      const origDATETRANS=text(tx,'DATETRANS');
      const origBIC=text(tx,'BIC_R');
      const origDATEVAL=text(tx,'DATEVAL');

      if(hD&&hC){
        const val=(kids[iD].textContent||'').trim().replace(',', '.');
        rmByRx(tx,/^(AMOUNT_D|DEBITAMOUNT|AMOUNT_C|CREDITAMOUNT)$/i);
        const amt=doc.createElement('AMOUNT_D'); amt.textContent=val;
        insAfter(tx,amt,child(tx,'TIME'));
      }else if(!hD&&!hC){
        let val='';
        const tr0=text(tx,'TR_NAME');
        let m=String(tr0||'').match(/-?\d+(?:[.,]\d+)?/);
        if(m) val=m[0];
        if(!val){
          const m2=text(tx,'MORE2');
          m=String(m2||'').match(/-([0-9]+(?:[.,]\d+)?)-BGN/i);
          if(m) val=m[1];
        }
        if(val){
          val=String(val).replace(',', '.').trim();
          const amt=doc.createElement('AMOUNT_C'); amt.textContent=val;
          insAfter(tx,amt,child(tx,'TIME'));
        }
      }
	  const defaultTrName = '–ö–ê–†–¢–û–í–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø';
      const nameSource = origREM_I ? 'REM_I' : (origDATETRANS ? 'DATETRANS' : null);
      const trName = nameSource==='REM_I' ? origREM_I : (nameSource==='DATETRANS' ? origDATETRANS : defaultTrName);      

      if(origBIC) set(tx,'REM_I',origBIC); else { const rmi=child(tx,'REM_I'); if(rmi) try{ tx.removeChild(rmi) }catch(_){ } }

      if(trName===defaultTrName){
        const r2=child(tx,'REM_II'); if(r2) try{ tx.removeChild(r2) }catch(_){}
      }else{
        if(nameSource) set(tx,'REM_II', trName);
      }
      set(tx,'TR_NAME',defaultTrName);

      if(origDATEVAL) set(tx,'REFERENCE',origDATEVAL);

      rmByRx(tx,/^(BIC_R|DATETRANS|DATEVAL|MORE\d{1,2})$/i);

      const amtNode=child(tx,'AMOUNT_D')||child(tx,'AMOUNT_C')||null;
      const desired=['POST_DATE','TIME'].concat(amtNode?[amtNode.tagName]:[],'TR_NAME','REM_I','REM_II','REFERENCE');
      const keep=new Set(desired.map(s=>s.toUpperCase()));
      A(tx.children).forEach(el=>{ if(!keep.has(el.tagName.toUpperCase())) tx.removeChild(el) });

      const map={}; desired.forEach(t=>map[t.toUpperCase()]=child(tx,t));
      const seq=[];
      desired.forEach(t=>{
        const el=map[t.toUpperCase()];
        if(!el) return;
        const v=(el.textContent||'').trim();
        if(!v && (t==='REM_I' || t==='REM_II' || t==='REFERENCE')){ try{ tx.removeChild(el) }catch(_){ } return }
        try{ tx.removeChild(el) }catch(_){ }
        seq.push(el);
      });
      seq.forEach(el=>tx.appendChild(el));
    }
    // –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏: —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    try{
      const xmlText = new XMLSerializer().serializeToString(doc)
      if(navigator && navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(xmlText)
          .then(()=>{ try{ toast('–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π XML —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä') }catch(_){ } })
          .catch(()=>{ try{ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å XML','warn') }catch(_){ } })
      }
    }catch(_){ }
  }catch(e){}
}
// Normalization END
function parseXmlTransactions(xmlText){
  
  // –ü—Ä–∏–≤–µ–¥—ë–º –≤–æ–∑–º–æ–∂–Ω—ã–π BOM/–∫–æ–¥–∏—Ä–æ–≤–∫—É: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ UTF-16LE/BE –∏ UTF-8
  if(typeof xmlText !== 'string'){
    xmlText = String(xmlText)
  }
  // –£–¥–∞–ª—è–µ–º BOM, –µ—Å–ª–∏ –µ—Å—Ç—å
  if(xmlText.charCodeAt(0)===0xFEFF){ xmlText = xmlText.slice(1) }
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, 'application/xml');
  const parserErr = doc.querySelector('parsererror');
  
  if(parserErr) {
    throw new Error('XML parse error');
  }
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–ª–æ–º–∞–Ω–Ω—ã–µ TRANSACTION (–µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã)
  try{ normalizeBrokenXmlIfNeeded(doc) }catch(_){ }
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º–µ–Ω–∞: –ø—Ä–∏–≤–µ–¥—ë–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
  function tagsLower(arr){ return arr.map(s=>String(s).toLowerCase()) }
  const amountTags = tagsLower(['amount','amt','sum','value','transactionamount','creditamount','debitamount','entryamount','bookedamount','instructedamount','amount_c','amount_d','—Ü–µ–Ω–Ω–æ—Å—Ç—å','—Å—É–º–º–∞','AMOUNT_C','AMOUNT_D'])
  const dateTags = tagsLower(['date','bookingdate','valuedate','posted','postdate','tradedate','transdate','entrydate','post_date','–¥–∞—Ç–∞','POST_DATE'])
  const indicatorTags = tagsLower(['creditdebitindicator','crdr','dc','drcr','debitcredit','direction','indicator','sign','–ø—Ä–∏–∑–Ω–∞–∫','—Ç–∏–ø'])
  const descTags = tagsLower(['description','narrative','details','memo','text','remittanceinformation','purpose','name','payee','merchant','counterparty','beneficiary','payer','receiver','reference','info','note','–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ','–æ–ø–∏—Å–∞–Ω–∏–µ','NAME_R','REM_I','REM_II'])
  const currencyTags = tagsLower(['currency','ccy','curr','–≤–∞–ª—é—Ç–∞'])
  const all = Array.from(doc.querySelectorAll('*'));
  const candidates = new Map();
  for(const el of all){
    const hasAmt = qAny(el, amountTags);
    const hasDate = qAny(el, dateTags);
    if(hasAmt && hasDate){
      const key = el.tagName.toLowerCase();
      candidates.set(key, (candidates.get(key)||0)+1);
    }
  }
  let txTag=null, best=0;
  for(const [k,v] of candidates){ if(v>best){best=v; txTag=k} }
  if(!txTag){ for(const k of ['transaction','entry','statementline','record','operation','row','item','movement']){ if(doc.getElementsByTagName(k).length){ txTag=k; break } } }
  // –í XML —Ç–µ–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–µ, –ø–æ—ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é
  const allEls = Array.from(doc.getElementsByTagName('*'))
  const nodes = txTag ? allEls.filter(n=>n.tagName.toLowerCase()===txTag) : []
  
  const txs=[]; let detectedCurrency=null;
  for(const n of nodes){
    // –í–∞—Ä–∏–∞–Ω—Ç —Å–æ —Å—Ç—Ä–æ–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ –¥–ª—è test.xml
    const directDate = (n.getElementsByTagName('POST_DATE')[0]||n.getElementsByTagName('post_date')[0])?.textContent?.trim()
    const directCredit = (n.getElementsByTagName('AMOUNT_C')[0]||n.getElementsByTagName('amount_c')[0])?.textContent?.trim()
    const directDebit = (n.getElementsByTagName('AMOUNT_D')[0]||n.getElementsByTagName('amount_d')[0])?.textContent?.trim()
    
    let dateStr = getFirstText(n, dateTags) || directDate
    const amtObj = getAmount(n, amountTags) || (directCredit?{value:directCredit,node:{tagName:'AMOUNT_C'}}: directDebit?{value:directDebit,node:{tagName:'AMOUNT_D'}}: null)
    if(!amtObj || !dateStr) { continue }
    
    let amt = parseAmountAuto(amtObj.value);
    const ind = getFirstText(n, indicatorTags);
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è AMOUNT_C –∏ AMOUNT_D  
    const creditAmt = getFirstText(n, ['creditamount', 'amount_c']);
    const debitAmt = getFirstText(n, ['debitamount', 'amount_d']);
    
    if(creditAmt && !debitAmt){ 
      amt = Math.abs(parseAmountAuto(creditAmt));
    }
    else if(debitAmt && !creditAmt){ 
      amt = -Math.abs(parseAmountAuto(debitAmt));
    }
    else if(ind){
      const s = ind.trim().toLowerCase();
      if(['cr','c','credit','–∫—Ä–µ–¥–∏—Ç'].includes(s)) amt = Math.abs(amt);
      else if(['dr','d','debit','–¥–µ–±–µ—Ç'].includes(s)) amt = -Math.abs(amt);
    }
    if(/^[‚àí‚Äì‚Äî-]/.test(String(amtObj.value).trim())) amt = -Math.abs(Math.abs(amt));
    const d = parseDateFlexible(dateStr); if(!d) continue;
    // –°–æ—Å—Ç–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ NAME_R / REM_II / REM_I / TR_NAME
    function getTagText(node, tag){
      const el = node.getElementsByTagName(tag)[0] || node.getElementsByTagName(String(tag).toLowerCase())[0]
      return (el && el.textContent) ? el.textContent.trim() : ''
    }
    function isTechnicalCode(s){
      if(!s) return false
      const v = String(s).trim()
      // –ü—Ä–∏–º–µ—Ä—ã: P2800093-51684383-039309-2025-07-29, WAY4BOOK-07-01-2025... –∏ –¥—Ä. –ú–Ω–æ–≥–æ –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ ¬´-¬ª –∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
      const technicalId = /^(?:[A-Z–ê-–Ø0-9]+-){2,}[A-Z–ê-–Ø0-9-]+(?:-\d{4}-\d{2}-\d{2})?$/
      // –ö–æ—Ä–æ—Ç–∫–∏–µ ¬´–∫–æ–¥—ã¬ª –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–æ—á—Ç–∏ –±–µ–∑ –±—É–∫–≤–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
      const mostlyCode = /^[A-Z–ê-–Ø0-9\-_.]{10,}$/
      return technicalId.test(v) || (mostlyCode.test(v) && !/\s/.test(v))
    }
    const trName = getTagText(n,'TR_NAME')
    const nameR  = getTagText(n,'NAME_R')
    const remI   = getTagText(n,'REM_I')
    const remII  = getTagText(n,'REM_II')
    const reference = getTagText(n,'REFERENCE')
    const genericTrNames = new Set(['–ö–ê–†–¢–û–í–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø','–¢–ê–ö–°–ê –ú–ï–ñ–î–£–ë.–ü–†–ï–í–û–î','–¢–ê–ö–°–ê –ò–ó–•. –í–ê–õ–£–¢–ï–ù –ü–†–ï–í–û–î','–ò–ó–•–û–î–Ø–© –í–ê–õ–£–¢–ï–ù –ü–†–ï–í–û–î –°–ï–ü–ê','–ò–ó–•–û–î–Ø–© –ü–†–ï–í–û–î –í –õ–í','–ü–†–ï–í–û–î','–¢–ê–ö–°–ê –û–ë–°–õ–£–ñ–í–ê–ù–ï'])
    const preferTrName = (trName && trName.trim() && trName.trim().toUpperCase() !== '–ö–ê–†–¢–û–í–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø') ? trName.trim() : ''
    const parts=[]
    if(preferTrName) parts.push(preferTrName)
    if(nameR) parts.push(nameR)
    if(remII && !isTechnicalCode(remII)) parts.push(remII)
    if(remI && !isTechnicalCode(remI)) parts.push(remI)
    let desc = parts.filter(Boolean).join(' | ')
    // –ë–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º REFERENCE –∫–∞–∫ —Ñ–æ–ª–±—ç–∫ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è
    desc = String(desc).trim()
    if(!desc && trName){ desc = trName.trim() }
    const curr = amtObj.currency || getFirstText(n, currencyTags) || (amtObj.node && (amtObj.node.getAttribute('ccy')||amtObj.node.getAttribute('currency')||amtObj.node.getAttribute('curr')));
    if(curr && !detectedCurrency) detectedCurrency = String(curr).trim().toUpperCase();
    txs.push({id:uid(),date:d.toISOString().slice(0,10),desc:String(desc).trim(),amount:amt,category:null,source:'import',trName: trName || null, nameR: nameR || null, remI: remI || null, remII: remII || null});
  }
  
  return {transactions:txs, currency:detectedCurrency};
}

// ===== –£–î–ê–õ–ï–ù–ò–ï –†–£–ß–ù–´–• –û–ü–ï–†–ê–¶–ò–ô =====
function deleteManualTx(id){
  const idx = STATE.vault.transactions.findIndex(t=>t.id===id)
  if(idx<0){ toast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','warn'); return }
  if(STATE.vault.transactions[idx].source!=='manual'){ toast('–£–¥–∞–ª—è—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏','warn'); return }
  STATE.vault.transactions.splice(idx,1)
  saveVault(); render(); toast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞')
}

// ===== –†–ê–ó–í–û–†–ê–ß–ò–í–ê–ï–ú–´–ï –ö–ê–†–¢–û–ß–ö–ò =====
function openExpanded(key){ window.UI=window.UI||{}; UI.expanded=key; renderExpanded(key) }
function closeExpanded(){ window.UI=window.UI||{}; UI.expanded=null; hideExpanded() }
function hideExpanded(){ const o=$('#dashOverlay'), m=$('#dashModal'); if(o) o.style.display='none'; if(m) m.style.display='none' }
function renderExpanded(key){
  const o=$('#dashOverlay'), m=$('#dashModal'), t=$('#dashModalTitle'), c=$('#dashModalContent')
  if(!o||!m||!t||!c) return
  o.style.display='block'; m.style.display='block';
  c.innerHTML=''
  const rs = t && t.parentElement ? t.parentElement.querySelector('.right') : null
  if(rs) rs.innerHTML=''
  const {months,byM}=monthBuckets()
  const labels = months
  if(key==='bar'){
    t.textContent='–î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º'
    c.innerHTML=`<canvas id="barBig" style="height:64vh"></canvas>`
    
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const barLabels = filteredMonths
    let barIncomes = filteredMonths.map(m=>filteredByM[m]?.income || 0)
    let barExpenses = filteredMonths.map(m=>filteredByM[m]?.expense || 0)
    if(TX_FILTER==='income'){ barExpenses = barExpenses.map(()=>0) }
    if(TX_FILTER==='expense'){ barIncomes = barIncomes.map(()=>0) }
    // Convert to display currency before drawing
    const barIncomesD = barIncomes.map(v=>convertValue(v))
    const barExpensesD = barExpenses.map(v=>convertValue(v))
    drawBarChart($('#barBig'), barLabels, [barIncomesD, barExpensesD], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'])
  }else if(key==='line'){
    t.textContent='–ß–∏—Å—Ç—ã–π –∏—Ç–æ–≥ –ø–æ –º–µ—Å—è—Ü–∞–º'
    c.innerHTML=`<canvas id="lineBig" style="height:64vh"></canvas>`
    
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const lineLabels = filteredMonths
    const lineNets = filteredMonths.map(m=>{
      const mData = filteredByM[m]||{income:0,expense:0,net:0}
      if(TX_FILTER==='income') return mData.income||0
      if(TX_FILTER==='expense') return -(mData.expense||0)
      return mData.net||0
    })
    // Convert to display currency before drawing
    const lineNetsD = lineNets.map(v=>convertValue(v))
    drawLineChart($('#lineBig'), lineLabels, lineNetsD)
  }else if(key==='pie'){
    t.textContent='–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤'
    c.innerHTML=`<canvas id="pieBig" style="height:64vh"></canvas>`
    
    const draw=()=>{ 
      const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
      
      // –ü–∏—Ä–æ–≥: —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const totalByCat = {}
      const tx = filteredTransactionsWithoutCategory().filter(t => (t.amount||0) < 0)
      tx.forEach(t=>{
        const cat=t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
        totalByCat[cat]=(totalByCat[cat]||0)+Math.abs(t.amount||0)
      })
      const l=Object.keys(totalByCat)
      const v=l.map(k=> convertValue(totalByCat[k]))
      drawDonutChart($('#pieBig'), l, v) 
    }
    draw(); 
  }else if(key==='recent'){
    const totalCount = getFilteredAndSearchedTransactions().length
    const expandLimit = totalCount // –í expand —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    t.textContent='–û–ø–µ—Ä–∞—Ü–∏–∏'
    if(rs){
      const catOptions = ['<option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>','<option value="__none__">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>'].concat((STATE.vault.categories||[]).map(c=>`<option ${CAT_FILTER===c?'selected':''} value="${c}">${c}</option>`)).join('')
      rs.innerHTML = '<div style="display:flex;gap:8px;align-items:center">'
        +'<select id="catFilterBig" title="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" style="font-size:13px">'+catOptions+'</select>'
        +'<input id="searchInputBig" type="text" placeholder="–ü–æ–∏—Å–∫..." value="'+SEARCH_TEXT+'" style="width:180px;font-size:13px">'
        +'</div>'
    }
    
    const updateBigTable = () => {
      const rows = getFilteredAndSearchedTransactions()
      const curr = STATE.vault.currency
      const tableContainer = c.querySelector('.table-scroll')
      
      if(tableContainer) {
        tableContainer.querySelector('tbody').innerHTML = rows.map(t=>`<tr title="${(()=>{const a=[]; if(t.trName) a.push('TR_NAME: '+escapeHtml(t.trName)); if(t.nameR) a.push('NAME_R: '+escapeHtml(t.nameR)); if(t.remI) a.push('REM_I: '+escapeHtml(t.remI)); if(t.remII) a.push('REM_II: '+escapeHtml(t.remII)); return a.join('\\n');})()}"><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${t.category?escapeHtml(t.category):`<button class=\"btn-small\" title=\"–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat=\"${t.id}\">‚úé</button>`}</td><td style=\"text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}\">${formatAmountDisplay(t.amount)}</td><td style=\"width:32px;text-align:right;\">${t.source==='manual'?`<button class=\"btn-small\" data-del-tx=\"${t.id}\">üóë</button>`:''}</td></tr>`).join('')
        // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        $$('[data-del-tx]', tableContainer).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')); updateBigTable() } })
        // –ò–Ω–ª–∞–π–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        $$('[data-edit-cat]', tableContainer).forEach(b=>{ b.onclick=()=>{ openQuickCategoryDialog(b.getAttribute('data-edit-cat')); updateBigTable() } })
      }
    }
    
    const rows = getFilteredAndSearchedTransactions()
    const curr = STATE.vault.currency
    c.innerHTML = `<div class="table-scroll" style="max-height:60vh">
      <table>
        <thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ <button data-copy-desc="1" class="icon-btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è (JSON)">üìã</button></th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style="text-align:right">–°—É–º–º–∞</th><th></th></tr></thead>
        <tbody>
          ${rows.map(t=>`<tr title="${(()=>{const a=[]; if(t.trName) a.push('TR_NAME: '+escapeHtml(t.trName)); if(t.nameR) a.push('NAME_R: '+escapeHtml(t.nameR)); if(t.remI) a.push('REM_I: '+escapeHtml(t.remI)); if(t.remII) a.push('REM_II: '+escapeHtml(t.remII)); return a.join('\\n');})()}"><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${t.category?escapeHtml(t.category):`<button class=\"btn-small\" title=\"–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é\" data-edit-cat=\"${t.id}\">‚úé</button>`}</td><td style=\"text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}\">${formatAmountDisplay(t.amount)}</td><td style=\"width:32px;text-align:right;\">${t.source==='manual'?`<button class=\"btn-small\" data-del-tx=\"${t.id}\">üóë</button>`:''}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>`
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –≤ expand —Ä–µ–∂–∏–º–µ
    const searchInputBig = $('#searchInputBig')
    const catFilterBig = $('#catFilterBig')
    // –ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    $$('[data-copy-desc]', c).forEach(btn=>{ btn.onclick = copyDescriptionsJSON })
    
    if(searchInputBig) {
      searchInputBig.oninput = () => {
        SEARCH_TEXT = searchInputBig.value
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–∂–µ
        const normalSearchInput = $('#searchInput')
        if(normalSearchInput) normalSearchInput.value = SEARCH_TEXT
        updateBigTable()
        updateRecentOperationsTable()
      }
    }
    if(catFilterBig){
      catFilterBig.onchange = () => {
        CAT_FILTER = catFilterBig.value
        const normalCatSel = $('#catFilterGlobal')
        if(normalCatSel) normalCatSel.value = CAT_FILTER
        updateBigTable(); updateRecentOperationsTable(); drawPieChart(); updateAllCharts()
      }
    }
    $$('[data-del-tx]', c).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
  }
}

function qAny(node, tags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(tags.includes(el.tagName.toLowerCase())) return true
  }
  return false
}
function getFirstText(node, tags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(tags.includes(el.tagName.toLowerCase())){
      const txt=(el.textContent||'').trim(); if(txt) return txt
    }
  }
  return null
}
function getAmount(node, amountTags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(amountTags.includes(el.tagName.toLowerCase())){
      const txt=(el.textContent||'').trim(); if(!txt) continue
      const curr = el.getAttribute('ccy')||el.getAttribute('currency')||el.getAttribute('curr')
      return {value:txt,currency:curr,node:el}
    }
  }
  return null
}
function parseAmountAuto(s){
  s=String(s).replace(/\s/g,'');
  if(s.includes('.') && s.includes(',')){ const lc=Math.max(s.lastIndexOf(','),0); const ld=Math.max(s.lastIndexOf('.'),0); if(lc>ld){ s=s.replace(/\./g,'').replace(',', '.') } else { s=s.replace(/,/g,'') } }
  else if(s.includes(',') && !s.includes('.')){ s=s.replace(',','.') }
  return parseFloat(s)
}

// ===== –≠–ö–°–ü–û–†–¢ –ê–ì–†–ï–ì–ê–¢–û–í =====
function exportAggregates(){
  const {months,byM}=monthBuckets();
  const data = months.map(m=>({month:m,income:+byM[m].income.toFixed(2),expense:+byM[m].expense.toFixed(2),net:+byM[m].net.toFixed(2),count:byM[m].items.length}));
  const payload = {currency:STATE.vault.currency, generatedAt:new Date().toISOString(), data};
  download(`ofb-aggregates-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2));
}

function labelOf(f){
  return {date:'–î–∞—Ç–∞', amount:'–°—É–º–º–∞', desc:'–û–ø–∏—Å–∞–Ω–∏–µ', category:'–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}[f]
}

function guessMapping(head){
  const lower=head.map(h=>String(h).toLowerCase())
  function find(...alts){for(const a of alts){const i=lower.findIndex(h=>h.includes(a)); if(i>=0) return i} return 0}
  return {
    date: find('date','–¥–∞—Ç–∞','booking','posted','operation'),
    amount: find('amount','—Å—É–º–º–∞','debit/credit','debit','credit','ammount'),
    desc: find('description','–æ–ø–∏—Å–∞–Ω–∏–µ','memo','details','note','reference'),
    category: find('category','–∫–∞—Ç–µ–≥–æ—Ä–∏—è','mcc','type')
  }
}

function rowToTx(r,map,dec,fmtSel){
  function parseAmt(s){ if(dec===',') s=s.replace(/\./g,'').replace(',','.'); return parseFloat(String(s).replace(/\s/g,'')) }
  function parseDateFmt(s){
    if(fmtSel==='auto') return parseDateFlexible(s)
    const m = String(s).match(/(\d{1,4})\D(\d{1,2})\D(\d{1,4})/)
    if(!m) return parseDateFlexible(s)
    let Y,M,D
    if(fmtSel==='Y-M-D'){Y=+m[1];M=+m[2];D=+m[3]}
    if(fmtSel==='D.M.Y'){D=+m[1];M=+m[2];Y=+m[3]}
    if(fmtSel==='M/D/Y'){M=+m[1];D=+m[2];Y=+m[3]}
    if(fmtSel==='D/M/Y'){D=+m[1];M=+m[2];Y=+m[3]}
    const d=new Date(Y,M-1,D); return isNaN(d)?null:d
  }
  try{
    const sDate=r[map.date], sAmt=r[map.amount], sDesc=r[map.desc], sCat=r[map.category]
    const d=parseDateFmt(sDate); if(!d) return null
    const a=parseAmt(sAmt); if(!isFinite(a) || a===0) return null
    return {id:uid(),date:d.toISOString().slice(0,10),desc:String(sDesc||'').trim(),amount:a,category:String(sCat||'').trim()||null,source:'import'}
  }catch(err){return null}
}

// ===== –ì–†–ê–§–ò–ö–ò (Canvas 2D, –±–µ–∑ –ª–∏–±) =====
// chart helpers moved to assets/charts.js

function download(name, content){
  // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã)
  const saveWithPicker = async ()=>{
    if(window.showSaveFilePicker){
      try{
        const handle = await showSaveFilePicker({
          suggestedName: name,
          types: [{ description:'JSON', accept:{'application/json':['.json']} }]
        })
        const writable = await handle.createWritable()
        await writable.write(new Blob([content],{type:'application/json'}))
        await writable.close()
        toast('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω')
        return true
      }catch(e){ /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ—Ç–º–µ–Ω–∏—Ç—å */ }
    }
    return false
  }
  ;(async()=>{
    const ok = await saveWithPicker()
    if(ok) return
    // –§–æ–ª–±—ç–∫ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫
    const a=document.createElement('a')
    a.href=URL.createObjectURL(new Blob([content],{type:'application/json'}))
    a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000)
    toast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –≤ –ø–∞–ø–∫—É data')
  })()
}

async function saveChartsPng(){
  const files=[]
  for(const id of ['bar','line','pie']){
    const c = $('#'+id)
    const blob = await new Promise(res=>c.toBlob(res))
    files.push({name:`${id}-${new Date().toISOString().slice(0,10)}.png`, blob})
  }
  for(const f of files){
    const a=document.createElement('a'); a.href=URL.createObjectURL(f.blob); a.download=f.name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800)
  }
  toast('–ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (PNG)')
}

// ===== –ò–ù–ò–¶ =====
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
initTheme()

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ header
$('#themeToggle').onclick = toggleTheme
$('#helpToggle').onclick = toggleHelp
const st=$('#settingsToggle'); if(st){ st.onclick = ()=>{ try{ PREFS.openModal() }catch(_){ } } }
// Currency selector: init from PREFS and sync back
;(function(){ try{ const sc=document.getElementById('selCurrency'); if(sc){ try{ sc.value = getDisplayCurrency() }catch(_){ } sc.onchange = ()=>{ try{ PREFS.set({ preferredCurrency: sc.value }) }catch(_){ } render() } } }catch(_){ } })()
$('#btnClearStorage').onclick = () => {
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å localStorage (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)?')) {
    localStorage.removeItem(LS_KEY)
    localStorage.removeItem('finboard_theme')
    try{ localStorage.removeItem('gn_state') }catch(_){ }
    try{ localStorage.removeItem('ofb_prefs') }catch(_){ }
    STATE = {unlocked:true, pass:null, vault:emptyVault()}
    window.UI = {}
    render()
    toast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã')
  }
}

render()

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞
disableImportButtons()

// –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—â–∏–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤
let ro=new ResizeObserver(()=>{ bindMain() })
ro.observe(document.body)

function clearFile(id){ const el=$('#'+id); if(!el) return; try{ el.value=''; }catch{ /* ignore */ } }

// helpHTML –≤—ã–Ω–µ—Å–µ–Ω –≤ assets/help.js

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º –¥–∞—à–±–æ—Ä–¥ (—Ü–≤–µ—Ç/—à—Ä–∏—Ñ—Ç –∏ –¥—Ä.)
try{ window.addEventListener('prefsChanged', ()=>{ render() }) }catch(_){ }
try{ window.addEventListener('prefsChanged', ()=>{ const sc=document.getElementById('selCurrency'); if(sc){ try{ sc.value = getDisplayCurrency() }catch(_){ } } render() }) }catch(_){ }

</script>
</body>
</html>



