<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- –°–º—è–≥—á—ë–Ω–Ω—ã–π CSP –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ file:// -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' blob: data: file:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'none'; frame-src 'none'">
  <title>FinBoard</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script src="assets/help.js"></script>
  <script src="assets/xml.js"></script>
  <script src="assets/charts.js"></script>
  <script src="assets/app.js"></script>
</head>
<body>
<div class="app">
  <header>
    <h1>FinBoard</h1>
    <span class="right"></span>
    <button id="btnClearStorage" class="header-clear" title="–û—á–∏—Å—Ç–∏—Ç—å localStorage">üóë –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <div id="themeToggle" class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span class="theme-icon">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
      </span>
    </div>
    <div id="helpToggle" class="help-toggle" title="–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É">
      <span class="help-icon">‚ùì</span>
    </div>
    <button id="btnLock" class="btn" style="display:none">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
  </header>

  <aside class="side" id="side"></aside>
  <main class="content" id="main"></main>
</div>

<script>
// ===== –£–¢–ò–õ–ò–¢–´ =====
const $ = (sel,root=document)=>root.querySelector(sel)
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel))
const fmt = new Intl.NumberFormat('ru-RU',{style:'currency',currency:'BGN',maximumFractionDigits:2})
const monthFmt = new Intl.DateTimeFormat('ru-RU',{year:'numeric',month:'2-digit'})
const dateFmt = new Intl.DateTimeFormat('ru-RU')

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–û–ô =====
function initTheme() {
  const savedTheme = localStorage.getItem('finboard_theme') || 'dark'
  document.documentElement.setAttribute('data-theme', savedTheme)
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark'
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
  document.documentElement.setAttribute('data-theme', newTheme)
  localStorage.setItem('finboard_theme', newTheme)
  toast(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ${newTheme === 'dark' ? '—Ç–µ–º–Ω—É—é' : '—Å–≤–µ—Ç–ª—É—é'} —Ç–µ–º—É`)
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ü–†–ê–í–ö–û–ô =====
let HELP_VISIBLE = false

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–ï–ô –û–ü–ï–†–ê–¶–ò–ô =====
let RECENT_LIMIT = 7
let SEARCH_TEXT = ''

function getFilteredAndSearchedTransactions() {
  let filtered = filteredTransactions()
  
  if (SEARCH_TEXT.trim()) {
    const searchLower = SEARCH_TEXT.toLowerCase()
    filtered = filtered.filter(t => {
      const desc = (t.desc || '').toLowerCase()
      const category = (t.category || '').toLowerCase()
      return desc.includes(searchLower) || category.includes(searchLower)
    })
  }
  
  return filtered.sort((a,b) => new Date(b.date) - new Date(a.date))
}

function toggleHelp() {
  HELP_VISIBLE = !HELP_VISIBLE
  const helpToggle = $('#helpToggle')
  const helpBlock = $('#helpBlock')
  
  if(helpToggle) {
    helpToggle.classList.toggle('active', HELP_VISIBLE)
    helpToggle.title = HELP_VISIBLE ? '–°–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É' : '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É'
  }
  
  if(helpBlock) {
    helpBlock.style.display = HELP_VISIBLE ? 'block' : 'none'
  }
  
  toast(HELP_VISIBLE ? '–°–ø—Ä–∞–≤–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞' : '–°–ø—Ä–∞–≤–∫–∞ —Å–∫—Ä—ã—Ç–∞')
}

const b64 = {
  enc: arr => btoa(String.fromCharCode(...arr)),
  dec: str => new Uint8Array(atob(str).split('').map(c=>c.charCodeAt(0)))
}

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function monthKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}

// ===== –®–ò–§–†–û–í–ê–ù–ò–ï (WebCrypto) =====
const KDF_ITER = 250000
async function deriveKey(pass, salt){
  const enc = new TextEncoder()
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey'])
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:KDF_ITER,hash:'SHA-256'}, keyMaterial, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt'])
}
async function encryptJSON(obj, pass){
  const salt = crypto.getRandomValues(new Uint8Array(16))
  const iv = crypto.getRandomValues(new Uint8Array(12))
  const key = await deriveKey(pass, salt)
  const enc = new TextEncoder()
  const data = enc.encode(JSON.stringify(obj))
  const cipher = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, data))
  return {v:1,algo:'AES-GCM',kdf:'PBKDF2',iter:KDF_ITER,salt:b64.enc(salt),iv:b64.enc(iv),data:b64.enc(cipher)}
}
async function decryptJSON(bundle, pass){
  const salt=b64.dec(bundle.salt), iv=b64.dec(bundle.iv), data=b64.dec(bundle.data)
  const key = await deriveKey(pass, salt)
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, data)
  const dec = new TextDecoder()
  return JSON.parse(dec.decode(new Uint8Array(plain)))
}

// ===== –•–†–ê–ù–ò–õ–ò–©–ï =====
const LS_KEY = 'ofb_vault'
let STATE = { unlocked:true, pass:null, vault: ensureVault(loadVaultPlain()) }

// ===== –§–ò–õ–¨–¢–† –ü–ï–†–ò–û–î–ê =====
let PERIOD_FILTER = { fromMonth: null, toMonth: null, mode: 'year', singleMonth: null, singleYear: null }
// –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–π: 'all' | 'income' | 'expense'
let TX_FILTER = (window.UI && UI.txFilter) ? UI.txFilter : 'all'

function ensureVault(v){
  try{
    if(!v || typeof v!=='object') return emptyVault()
    if(!Array.isArray(v.transactions)) v.transactions=[]
    if(!v.adjustments || typeof v.adjustments!=='object') v.adjustments={}
    if(!v.currency) v.currency='BGN'
    return v
  }catch{ return emptyVault() }
}

function loadBundle(){
  const raw = localStorage.getItem(LS_KEY)
  return raw?JSON.parse(raw):null
}
function loadVaultPlain(){
  try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):null }catch{ return null }
}
async function saveVault(){
  if(!STATE.vault) return
  localStorage.setItem(LS_KEY, JSON.stringify(STATE.vault))
  toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ')
}

// –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏ UI –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∏–º–ø–æ—Ä—Ç–æ–º
function resetBeforeImport(kind){
  try{ localStorage.removeItem(LS_KEY) }catch(e){}
  STATE = {unlocked:true, pass:null, vault: emptyVault()}
  window.UI = {}
  // –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ç–∞–∫–∂–µ –æ—á–∏—Å—Ç–∏–º –≤—ã–±–æ—Ä XML
  if(kind==='vault'){
    try{ clearFile('bankXml') }catch(e){}
    try{ clearXmlSelection() }catch(e){}
  }
  render()
}

function setCurrency(cur){
  try{STATE.vault.currency=cur; (fmt.resolvedOptions().currency!==cur);}
  catch(e){}
  // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–¥–∏–º —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
  window.fmt = new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur,maximumFractionDigits:2})
  render()
}

// ===== –¢–û–°–¢ =====
let toastTimer=null
function toast(text,kind='success'){
  clearTimeout(toastTimer)
  let el=$('#toast')
  if(!el){
    el=document.createElement('div')
    el.id='toast'
    el.style.position='fixed';el.style.right='16px';el.style.bottom='16px';el.style.zIndex='9999';el.style.maxWidth='320px'
    document.body.appendChild(el)
  }
  el.innerHTML = `<div class="${kind==='success'?'success':'warnbox'}">${text}</div>`
  toastTimer=setTimeout(()=>{el.innerHTML=''},2400)
}

// ===== –ü–ê–†–°–ò–ù–ì –î–ê–¢–´/CSV =====
function parseDateFlexible(s){
  s = (s||'').trim()
  // –ø–æ–¥–¥–µ—Ä–∂–∫–∞: YYYY-MM-DD, DD.MM.YYYY, MM/DD/YYYY, DD/MM/YYYY
  let m
  if((m=s.match(/^(\d{4})[-.\/]?(\d{2})[-.\/]?(\d{2})$/))) return new Date(+m[1],+m[2]-1,+m[3])
  if((m=s.match(/^(\d{2})[.](\d{2})[.](\d{4})$/))) return new Date(+m[3],+m[2]-1,+m[1])
  if((m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/))){
    // –í—Å–µ–≥–¥–∞ —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ DD/MM/YYYY (–µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
    const d=+m[1], mo=+m[2], y=+m[3]
    return new Date(y,mo-1,d)
  }
  const d=new Date(s); if(!isNaN(d)) return d
  return null
}

function detectDelimiter(text){
  const candidates=[',',';','\t','|']
  const lines=text.split(/\r?\n/).slice(0,5)
  let best=',',score=0
  for(const d of candidates){
    const counts=lines.map(l=>l.split(d).length)
    const uniq=new Set(counts)
    const s = counts.reduce((a,b)=>a+b,0)
    if(uniq.size===1 && s>score){best=d;score=s}
  }
  return best
}

function parseCSV(text){
  const delim = detectDelimiter(text)
  const rows=[]; let i=0, cur='', inQ=false
  function pushCell(){(rows[rows.length-1]||rows.push([]),rows[rows.length-1]).push(cur);cur=''}
  function pushRow(){if(rows.length===0||rows[rows.length-1].length) rows.push([])}
  rows.push([])
  while(i<text.length){
    const ch=text[i]
    if(ch==='"'){
      if(inQ && text[i+1]==='"'){cur+='"'; i+=2; continue}
      inQ=!inQ; i++; continue
    }
    if(!inQ && (ch==='\n' || ch==='\r')){ pushCell(); pushRow(); if(ch==='\r'&&text[i+1]==='\n') i++; i++; continue }
    if(!inQ && text.substr(i,delim.length)===delim){ pushCell(); i+=delim.length; continue }
    cur+=ch; i++
  }
  pushCell()
  // —É–¥–∞–ª–∏—Ç—å –ø—É—Å—Ç—ã–µ –ø–æ—Å–ª–µ–¥–Ω—é—é/–ø–µ—Ä–≤—É—é
  return rows.filter(r=>r.length && r.some(c=>String(c).trim().length))
}

// ===== –ú–û–î–ï–õ–¨ –î–ê–ù–ù–´–• =====
function emptyVault(){
  return {
    currency:'BGN',
    transactions:[], // {id,date:ISO,desc,amount:number,category?:string,source:'import'|'manual'}
    adjustments:{}, // { 'YYYY-MM': number }
    createdAt: new Date().toISOString(),
    version:1
  }
}

function addTransactions(list){
  for(const t of list){ STATE.vault.transactions.push(t) }
}

function addManual(tx){ STATE.vault.transactions.push(tx) }

function setAdjustment(month, amount){ STATE.vault.adjustments[month]=amount }

function monthBuckets(){
  const byM = {}
  for(const t of STATE.vault.transactions){
    const d=new Date(t.date), m=monthKey(d)
    ;(byM[m]||(byM[m]={income:0,expense:0,net:0,items:[],byCat:{}}))
    byM[m].items.push(t)
    if(t.amount>=0) byM[m].income+=t.amount; else byM[m].expense+=-t.amount
    byM[m].net += t.amount
    const cat=t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
    byM[m].byCat[cat]=(byM[m].byCat[cat]||0)+Math.abs(t.amount)
  }
  for(const m in STATE.vault.adjustments){
    const a=STATE.vault.adjustments[m]||0
    ;(byM[m]||(byM[m]={income:0,expense:0,net:0,items:[],byCat:{}}))
    byM[m].net += a
    if(a>=0) byM[m].income += a; else byM[m].expense += -a
    byM[m].byCat['–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏']=(byM[m].byCat['–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏']||0)+Math.abs(a)
  }
  const months=Object.keys(byM).sort()
  return {months, byM}
}

function filteredMonthBuckets(){
  const {months, byM} = monthBuckets()
  
  if(PERIOD_FILTER.mode === 'month' && PERIOD_FILTER.singleMonth) {
    // –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    const filteredMonths = months.filter(m => m === PERIOD_FILTER.singleMonth)
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'period' && PERIOD_FILTER.fromMonth && PERIOD_FILTER.toMonth) {
    // –†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∞
    const filteredMonths = months.filter(m => m >= PERIOD_FILTER.fromMonth && m <= PERIOD_FILTER.toMonth)
    return {months: filteredMonths, byM}
  } else if(PERIOD_FILTER.mode === 'year' && PERIOD_FILTER.singleYear) {
    // –†–µ–∂–∏–º –≥–æ–¥–∞
    const y = PERIOD_FILTER.singleYear
    const filteredMonths = months.filter(m => m.startsWith(y + '-'))
    return {months: filteredMonths, byM}
  }
  
  return {months, byM}
}

function filteredTransactions(){
  if(PERIOD_FILTER.mode === 'month' && PERIOD_FILTER.singleMonth) {
    // –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    return STATE.vault.transactions.filter(t => {
      const month = monthKey(new Date(t.date))
      if(month !== PERIOD_FILTER.singleMonth) return false
      if(TX_FILTER==='income') return (t.amount||0) >= 0
      if(TX_FILTER==='expense') return (t.amount||0) < 0
      return true
    })
  } else if(PERIOD_FILTER.mode === 'period' && PERIOD_FILTER.fromMonth && PERIOD_FILTER.toMonth) {
    // –†–µ–∂–∏–º –ø–µ—Ä–∏–æ–¥–∞
    return STATE.vault.transactions.filter(t => {
      const month = monthKey(new Date(t.date))
      if(!(month >= PERIOD_FILTER.fromMonth && month <= PERIOD_FILTER.toMonth)) return false
      if(TX_FILTER==='income') return (t.amount||0) >= 0
      if(TX_FILTER==='expense') return (t.amount||0) < 0
      return true
    })
  } else if(PERIOD_FILTER.mode === 'year' && PERIOD_FILTER.singleYear) {
    // –†–µ–∂–∏–º –≥–æ–¥–∞
    return STATE.vault.transactions.filter(t => {
      const m = monthKey(new Date(t.date))
      if(!m.startsWith(PERIOD_FILTER.singleYear + '-')) return false
      if(TX_FILTER==='income') return (t.amount||0) >= 0
      if(TX_FILTER==='expense') return (t.amount||0) < 0
      return true
    })
  }
  
  return [...STATE.vault.transactions].filter(t=>{
    if(TX_FILTER==='income') return (t.amount||0) >= 0
    if(TX_FILTER==='expense') return (t.amount||0) < 0
    return true
  })
}

// ===== –†–ï–ù–î–ï–† =====
function render(){
  $('#side').innerHTML = sideUI()
  $('#main').innerHTML = mainUI()
  bindSide()
  bindMain()
}

// –≤—ã–∫–ª—é—á–µ–Ω–æ: —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –±–µ–∑ –ø–∞—Ä–æ–ª—è

function sideUI(){
  return `
  <div class="card">
    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤—ã–ø–∏—Å–∫–∏</h3>
    <div class="hr"></div>
    <div class="grid-sm">
      <label class="btn" for="inputImportVault">–ò–º–ø–æ—Ä—Ç</label>
      <button id="btnExportVault" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <input id="inputImportVault" type="file" accept="application/json,.json" class="hidden" />
    </div>
  </div>

  <div class="card">
    <h3>–ò–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–∫–∏ UBB (XML)</h3>
    <div class="hr"></div>
    
    <!-- –ó–æ–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
    <div id="xmlDropzone" class="dropzone">
      <label id="btnChooseXml" class="btn" for="bankXml">üìÅ –í—ã–±—Ä–∞—Ç—å XML —Ñ–∞–π–ª</label>
      <input id="bankXml" type="file" accept=".xml,text/xml,application/xml" class="hidden" onchange="onXmlChosen(event)" />
      <div class="help" style="margin-top:8px">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ —Å—é–¥–∞</div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ -->
    <div id="xmlFileInfo" style="display:none;margin-top:12px;padding:12px;background:var(--card);border:1px solid var(--accent);border-radius:8px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="color:var(--accent);font-size:16px;">‚úì</span>
        <div id="xmlFileName" style="font-weight:600;color:var(--text);"></div>
      </div>
      <div id="xmlInfo" style="color:var(--accent);font-weight:500;margin-bottom:4px;"></div>
      <div id="xmlStatus" style="color:var(--muted);font-size:12px;"></div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="hr"></div>
    <div class="controls">
      <button id="btnClearXml" class="btn" disabled>–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="btnDoImportXml" class="primary" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>`
}

function mainUI(){
  const {months,byM}=monthBuckets()
  const lastM = months[months.length-1]
  const curr = STATE.vault.currency
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
  if(months.length > 0){
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    // populate years select later in bindMain
    if(!PERIOD_FILTER.singleYear){ PERIOD_FILTER.singleYear = years[years.length-1] }
    if(!PERIOD_FILTER.fromMonth){ PERIOD_FILTER.fromMonth = months[0] }
    if(!PERIOD_FILTER.toMonth){ PERIOD_FILTER.toMonth = months[months.length-1] }
    if(!PERIOD_FILTER.singleMonth){ PERIOD_FILTER.singleMonth = lastM || months[months.length-1] }
  }
  
  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–ª—å—Ç—Ä–∞
  const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
  const totalIncome = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='expense')?0:(filteredByM[m]?.income||0)),0)
  const totalExpense = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='income')?0:(filteredByM[m]?.expense||0)),0)
  const totalNet = totalIncome - totalExpense
  
  const allSearched = getFilteredAndSearchedTransactions()
  const recent = allSearched.slice(0, RECENT_LIMIT)

  return `
  <div id="helpBlock" style="display:none">${helpHTML()}</div>
  <div class="card filter-card" style="margin-top:12px">
    <div class="filter-header">
      <h3>–§–∏–ª—å—Ç—Ä –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
      <button id="btnOpenAdd" class="primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>
    
    <div class="filter-body">
      <div class="filter-controls-grid">
        <div class="filter-section">
          <label class="filter-label">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–π</label>
          <select id="txType" class="filter-select">
            <option value="all">–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</option>
            <option value="income">–¢–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥—ã</option>
            <option value="expense">–¢–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã</option>
          </select>
        </div>
        
        <div class="filter-section">
          <label class="filter-label">–ü–µ—Ä–∏–æ–¥</label>
          <div class="filter-mode-tabs">
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="year" ${PERIOD_FILTER.mode==='year'?'checked':''}>
              <span>–ì–æ–¥</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="month" ${PERIOD_FILTER.mode==='month'?'checked':''}>
              <span>–ú–µ—Å—è—Ü</span>
            </label>
            <label class="filter-tab">
              <input type="radio" name="filterMode" value="period" ${PERIOD_FILTER.mode==='period'?'checked':''}>
              <span>–î–∏–∞–ø–∞–∑–æ–Ω</span>
            </label>
          </div>
        </div>
        
        <div class="filter-section filter-params">
          <div id="yearControls" class="filter-param-group">
            <select id="globalYear" class="filter-select"></select>
          </div>
          <div id="monthControls" class="filter-param-group" style="display:none">
            <select id="globalSingleMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.singleMonth?'selected':''}>${m}</option>`).join('')}</select>
          </div>
          <div id="periodControls" class="filter-param-group period-group" style="display:none">
            <div class="period-inputs">
              <div class="period-input">
                <label>–û—Ç</label>
                <select id="globalFromMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.fromMonth?'selected':''}>${m}</option>`).join('')}</select>
              </div>
              <div class="period-input">
                <label>–î–æ</label>
                <select id="globalToMonth" class="filter-select">${months.map(m=>`<option ${m===PERIOD_FILTER.toMonth?'selected':''}>${m}</option>`).join('')}</select>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="filter-stats-row">
        <div class="stat-card income">
          <span class="stat-label">–î–æ—Ö–æ–¥—ã</span>
          <span id="incomeValue" class="stat-value">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalIncome)}</span>
        </div>
        <div class="stat-card expense">
          <span class="stat-label">–†–∞—Å—Ö–æ–¥—ã</span>
          <span id="expenseValue" class="stat-value">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalExpense)}</span>
        </div>
        <div class="stat-card net ${totalNet>=0?'positive':'negative'}">
          <span class="stat-label">–ò—Ç–æ–≥–æ</span>
          <span id="netValue" class="stat-value">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalNet)}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row cols-2" style="margin-top:12px">
    <div class="card"><div class="controls"><b>–î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</b><span class="right"></span><button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="bar">‚§¢</button></div><canvas id="bar"></canvas></div>
    <div class="card"><div class="controls"><b>–ß–∏—Å—Ç—ã–π –∏—Ç–æ–≥ –ø–æ –º–µ—Å—è—Ü–∞–º</b><span class="right"></span><button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="line">‚§¢</button></div><canvas id="line"></canvas></div>
  </div>

  <div class="row cols-2" style="margin-top:12px">
    <div class="card">
      <div class="controls"><b>–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</b>
        <span class="right"></span>
        <label class="pill">–¢–∏–ø<select id="pieMode" style="margin-left:6px"><option value="income_expense">–î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã</option><option value="categories">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option></select></label>
        <button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="pie" style="margin-left:8px">‚§¢</button>
      </div>
      <canvas id="pie"></canvas>
    </div>
    <div class="card">
      <div class="controls">
        <b>–û–ø–µ—Ä–∞—Ü–∏–∏</b>
        <span class="right"></span>
        <label class="pill" style="margin-left:8px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ <input id="recentLimit" type="number" min="1" max="50" value="${RECENT_LIMIT}" style="width:60px;margin-left:4px"> –∏–∑ <span id="recentTotalCount">${allSearched.length}</span></label>
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é..." value="${SEARCH_TEXT}" style="width:180px">
        <button class="icon-btn" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" data-expand="recent" style="margin-left:8px">‚§¢</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style="text-align:right">–°—É–º–º–∞</th><th></th></tr></thead>
          <tbody>
            ${recent.map(t=>`<tr><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${escapeHtml(t.category||'')}</td><td style="text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(t.amount)}</td><td style="width:32px;text-align:right;">${t.source==='manual'?`<button class="btn-small" data-del-tx="${t.id}">üóë</button>`:''}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="dashOverlay" class="overlay"></div>
  <div id="dashModal" class="modal">
    <div class="head inline"><h3 id="dashModalTitle" style="margin:0"></h3><span class="right"></span><button id="btnCloseDashModal" class="icon-btn" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button></div>
    <div id="dashModalContent"></div>
  </div>`
}

function bindMain(){
  const {months,byM}=monthBuckets()
  
  // –î–ª—è —Å—Ç–æ–ª–±—á–∞—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
  const barLabels = filteredMonths
  let barIncomes = filteredMonths.map(m=>filteredByM[m]?.income || 0)
  let barExpenses = filteredMonths.map(m=>filteredByM[m]?.expense || 0)
  if(TX_FILTER==='income'){ barExpenses = barExpenses.map(()=>0) }
  if(TX_FILTER==='expense'){ barIncomes = barIncomes.map(()=>0) }
  
  // –î–ª—è –ª–∏–Ω–µ–π–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  const lineLabels = filteredMonths
  const lineNets = filteredMonths.map(m=>{
    const mData = filteredByM[m]||{income:0,expense:0,net:0}
    if(TX_FILTER==='income') return mData.income||0
    if(TX_FILTER==='expense') return -(mData.expense||0)
    return mData.net||0
  })

  drawBarChart($('#bar'), barLabels, [barIncomes, barExpenses], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'])
  drawLineChart($('#line'), lineLabels, lineNets)

  const modeSelect=$('#pieMode')
  function drawPieChart(){
    const mode = modeSelect ? modeSelect.value : 'income_expense'
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    
    // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º –≤ —Ñ–∏–ª—å—Ç—Ä–µ
    let totalIncome = 0, totalExpense = 0, totalByCat = {}
    filteredMonths.forEach(m => {
      const monthData = filteredByM[m]
      if(monthData) {
        totalIncome += (TX_FILTER==='expense') ? 0 : (monthData.income || 0)
        totalExpense += (TX_FILTER==='income') ? 0 : (monthData.expense || 0)
      }
    })
    // –ü–µ—Ä–µ—Å—á—ë—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ—Ä–µ–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const txForCats = filteredTransactions()
    txForCats.forEach(t=>{
      const cat = t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
      totalByCat[cat] = (totalByCat[cat]||0) + Math.abs(t.amount||0)
    })
    
    if(mode === 'categories'){
      const labels2=Object.keys(totalByCat)
      const vals=labels2.map(k=>totalByCat[k])
      drawDonutChart($('#pie'), labels2, vals)
    }else{
      drawDonutChart($('#pie'), ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'], [totalIncome, totalExpense])
    }
  }
  
  drawPieChart() // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
  
  if(modeSelect){
    modeSelect.value = (window.UI && UI.pieCats) ? 'categories' : 'income_expense'
    modeSelect.onchange=()=>{ 
      window.UI=window.UI||{}; 
      UI.pieCats = modeSelect.value === 'categories'
      drawPieChart()
    }
  }
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≥–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω)
  const periodControls = $('#periodControls')
  const monthControls = $('#monthControls')
  const yearControls = $('#yearControls')
  if(periodControls) periodControls.style.display = (PERIOD_FILTER.mode==='period') ? 'flex' : 'none'
  if(monthControls) monthControls.style.display = (PERIOD_FILTER.mode==='month') ? 'flex' : 'none'
  if(yearControls) yearControls.style.display = (PERIOD_FILTER.mode==='year') ? 'flex' : 'none'
  // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–π
  const txType = $('#txType')
  if(txType){
    txType.value = (window.UI && UI.txFilter) ? UI.txFilter : TX_FILTER
    txType.onchange = () => {
      window.UI = window.UI || {}
      UI.txFilter = txType.value
      TX_FILTER = txType.value
      updateAllCharts()
    }
  }
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  function updateAllCharts(){
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const barLabels = filteredMonths
    let barIncomes = filteredMonths.map(m=>filteredByM[m]?.income || 0)
    let barExpenses = filteredMonths.map(m=>filteredByM[m]?.expense || 0)
    if(TX_FILTER==='income'){ barExpenses = barExpenses.map(()=>0) }
    if(TX_FILTER==='expense'){ barIncomes = barIncomes.map(()=>0) }
    const lineNets = filteredMonths.map(m=>{
      const mData = filteredByM[m]||{income:0,expense:0,net:0}
      if(TX_FILTER==='income') return mData.income||0
      if(TX_FILTER==='expense') return -(mData.expense||0)
      return mData.net||0
    })
    
    drawBarChart($('#bar'), barLabels, [barIncomes, barExpenses], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'])
    drawLineChart($('#line'), barLabels, lineNets)
    drawPieChart()
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStats()
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—É –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
    updateRecentOperationsTable()
  }
  
  function updateStats(){
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const totalIncome = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='expense')?0:(filteredByM[m]?.income||0)),0)
    const totalExpense = filteredMonths.reduce((s,m)=>s+((TX_FILTER==='income')?0:(filteredByM[m]?.expense||0)),0)
    const totalNet = totalIncome - totalExpense
    const curr = STATE.vault.currency
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–æ–º–æ—â—å—é ID
    const incomeEl = $('#incomeValue')
    const expenseEl = $('#expenseValue')
    const netEl = $('#netValue')
    const netCard = netEl?.closest('.stat-card')
    
    if(incomeEl) incomeEl.textContent = new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalIncome)
    if(expenseEl) expenseEl.textContent = new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalExpense)
    if(netEl) {
      netEl.textContent = new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(totalNet)
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
      if(netCard) {
        netCard.classList.remove('positive', 'negative')
        netCard.classList.add(totalNet >= 0 ? 'positive' : 'negative')
      }
    }
  }
  
  function updateRecentOperationsTable(){
    const allSearched = getFilteredAndSearchedTransactions()
    const recent = allSearched.slice(0, RECENT_LIMIT)
    const curr = STATE.vault.currency
    const tbody = $('#main .table-scroll tbody')
    if(tbody) {
      tbody.innerHTML = recent.map(t=>`<tr><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${escapeHtml(t.category||'')}</td><td style="text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(t.amount)}</td><td style="width:32px;text-align:right;">${t.source==='manual'?`<button class="btn-small" data-del-tx="${t.id}">üóë</button>`:''}</td></tr>`).join('')
      // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      $$('[data-del-tx]', tbody).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ "–∏–∑ y"
      const totalEl = $('#recentTotalCount')
      if(totalEl) totalEl.textContent = String(allSearched.length)
    }
  }

  // –†–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
  $$('input[name="filterMode"]').forEach(radio => {
    radio.onchange = () => {
      PERIOD_FILTER.mode = radio.value
      const periodControls = $('#periodControls')
      const monthControls = $('#monthControls')
      const yearControls = $('#yearControls')
      
      if(radio.value === 'period') {
        periodControls.style.display = 'flex'
        monthControls.style.display = 'none'
        yearControls.style.display = 'none'
      } else if(radio.value === 'month') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'flex'
        yearControls.style.display = 'none'
      } else if(radio.value === 'year') {
        periodControls.style.display = 'none'
        monthControls.style.display = 'none'
        yearControls.style.display = 'flex'
      }
      updateAllCharts()
    }
  })

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ (–æ—Ç/–¥–æ)
  const globalFromMonth = $('#globalFromMonth')
  const globalToMonth = $('#globalToMonth')
  if(globalFromMonth) globalFromMonth.onchange = () => {
    PERIOD_FILTER.fromMonth = globalFromMonth.value
    updateAllCharts()
  }
  if(globalToMonth) globalToMonth.onchange = () => {
    PERIOD_FILTER.toMonth = globalToMonth.value
    updateAllCharts()
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
  const globalSingleMonth = $('#globalSingleMonth')
  if(globalSingleMonth) globalSingleMonth.onchange = () => {
    PERIOD_FILTER.singleMonth = globalSingleMonth.value
    updateAllCharts()
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–æ–¥–∞
  const globalYear = $('#globalYear')
  if(globalYear){
    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª–µ—Ç
    const {months} = monthBuckets()
    const years = Array.from(new Set(months.map(m=>m.split('-')[0]))).sort()
    globalYear.innerHTML = years.map(y=>`<option ${y===PERIOD_FILTER.singleYear?'selected':''}>${y}</option>`).join('')
    globalYear.onchange = () => {
      PERIOD_FILTER.singleYear = globalYear.value
      updateAllCharts()
    }
  }

  const btn=$('#btnOpenAdd'); if(btn) btn.onclick=openAddModal
  $$('[data-expand]').forEach(b=>{ b.onclick=()=>{ openExpanded(b.getAttribute('data-expand')) } })
  $$('[data-del-tx]').forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –æ–ø–µ—Ä–∞—Ü–∏–π
  const recentLimitInput = $('#recentLimit')
  const searchInput = $('#searchInput')
  
  if(recentLimitInput) {
    recentLimitInput.oninput = () => {
      const newLimit = parseInt(recentLimitInput.value) || 7
      if(newLimit >= 1 && newLimit <= 50) {
        RECENT_LIMIT = newLimit
        updateRecentOperationsTable()
      }
    }
  }
  
  if(searchInput) {
    searchInput.oninput = () => {
      SEARCH_TEXT = searchInput.value
      updateRecentOperationsTable()
    }
  }
  const overlay=$('#dashOverlay'); if(overlay){ overlay.onclick=closeExpanded }
  const closeBtn=$('#btnCloseDashModal'); if(closeBtn){ closeBtn.onclick=closeExpanded }
  if(window.UI&&UI.expanded){ renderExpanded(UI.expanded) } else { hideExpanded() }
}

function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
}

function bindUnlock(){
  $('#btnUnlock').onclick = async ()=>{
    const pass = $('#pass').value.trim()
    if(pass.length<8){toast('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π','warn');return}
    const bundle = loadBundle()
    if(bundle){
      try{
        const vault = await decryptJSON(bundle, pass)
        STATE={unlocked:true,pass,vault}
        toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ')
        render()
      }catch(e){ toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ','warn') }
    }else{
      STATE={unlocked:true,pass,vault:emptyVault()}
      await saveVault(); render()
    }
  }
  $('#restoreFile').onchange = async (e)=>{
    const file=e.target.files[0]; if(!file) return
    const text=await file.text()
    try{ JSON.parse(text); localStorage.setItem(LS_KEY,text); toast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –¢–µ–ø–µ—Ä—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ.','success') }
    catch(err){ toast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏','warn') }
  }
}

function bindSide(){
  // –•—Ä–∞–Ω–∏–ª–∏—â–µ
  $('#btnExportVault').onclick=()=>{
    const data = localStorage.getItem(LS_KEY)
    if(!data){toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','warn');return}
    download(`ofb-vault-${new Date().toISOString().slice(0,10)}.json`, data)
  }
  $('#inputImportVault').onchange=async (e)=>{
    const f=e.target.files[0]; if(!f) return
    const t=await f.text();
    try{
      const parsed = ensureVault(JSON.parse(t))
      // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤–æ–≥–æ
      resetBeforeImport('vault')
      localStorage.setItem(LS_KEY, JSON.stringify(parsed))
      STATE.vault = parsed
      toast('–•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ.')
      render()
    }catch(err){
      toast('–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π —Ñ–∞–π–ª','warn')
    }
  }
  // –£–±—Ä–∞–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ¬´–°–ø—Ä–∞–≤–∫–∞¬ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–ª–æ–∫ ¬´–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è¬ª

  // XML –∏–º–ø–æ—Ä—Ç - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞–Ω –≤ HTML onchange="onXmlChosen(event)"
  const bankXml = $('#bankXml'); 
  $('#btnDoImportXml').onclick = doImportXml
  $('#btnClearXml').onclick = () => { 
    clearFile('bankXml'); 
    clearXmlSelection();
    toast('–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –æ—á–∏—â–µ–Ω');
  }
  const dz = $('#xmlDropzone')
  ;['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault(); dz.classList.add('drag')}))
  ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,(e)=>{e.preventDefault(); dz.classList.remove('drag')}))
  dz.addEventListener('drop', async (e)=>{ const f=e.dataTransfer.files?.[0]; if(f){ $('#bankXml').files = e.dataTransfer.files; await onXmlChosen() } })

  // CSV –æ—Ç–∫–ª—é—á—ë–Ω
}

// CSV –∏–º–ø–æ—Ä—Ç —É–¥–∞–ª—ë–Ω

// ===== –ò–ú–ü–û–†–¢ –í–´–ü–ò–°–ö–ò (XML) =====
let PENDING_XML_TEXT=null

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è HTML onchange
window.onXmlChosen = async function(event) {
  try{
    const inp = event ? event.target : $('#bankXml'); 
    if (!inp) { 
      toast('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input bankXml','warn'); 
      return;
    }
    const file = inp.files && inp.files[0]; 
    if (!file) {
      clearXmlSelection();
      return;
    }
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const xmlFileInfoEl = $('#xmlFileInfo');
    const xmlFileNameEl = $('#xmlFileName');
    const xmlInfoEl = $('#xmlInfo');
    const xmlStatusEl = $('#xmlStatus');
    // Fallback –µ—Å–ª–∏ readFileTextSmart –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞
    if (typeof readFileTextSmart !== 'function') {
      const readFileTextSmart = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(e);
          reader.readAsText(file, 'UTF-8');
        });
      };
      window.readFileTextSmart = readFileTextSmart;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    if (xmlFileInfoEl) {
      xmlFileInfoEl.style.display = 'block';
    }
    if (xmlFileNameEl) {
      // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
      const truncateFileName = (name, maxLength = 20) => {
        return name.length > maxLength ? name.substring(0, maxLength) + '...' : name;
      };
      xmlFileNameEl.textContent = `${truncateFileName(file.name)} (${(file.size/1024).toFixed(1)} KB)`;
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ title –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      xmlFileNameEl.title = file.name;
    }
    if (xmlStatusEl) {
      xmlStatusEl.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...';
      xmlStatusEl.style.color = 'var(--muted)';
    }
    // –ß–∏—Ç–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º —Ñ–∞–π–ª
    const text = await readFileTextSmart(file); 
    PENDING_XML_TEXT = text;
    const info = previewXml(text);
    if (info.count > 0) {
      const infoText = `${info.count} –æ–ø–µ—Ä–∞—Ü–∏–π ¬∑ ${info.firstDate} ‚Äî ${info.lastDate}${info.currency ? ` ¬∑ ${info.currency}` : ''}`;
      if (xmlInfoEl) {
        xmlInfoEl.textContent = infoText;
        xmlInfoEl.style.color = 'var(--accent)';
      }
      if (xmlStatusEl) {
        xmlStatusEl.textContent = '–ì–æ—Ç–æ–≤ –∫ –∏–º–ø–æ—Ä—Ç—É';
        xmlStatusEl.style.color = 'var(--ok)';
      }
      enableXmlButtons();
    } else {
      if (xmlInfoEl) {
        xmlInfoEl.textContent = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ñ–∞–π–ª–µ';
        xmlInfoEl.style.color = 'var(--warn)';
      }
      if (xmlStatusEl) {
        xmlStatusEl.textContent = '–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π';
        xmlStatusEl.style.color = 'var(--warn)';
      }
      disableXmlButtons();
    }
  } catch(e) { 
    toast('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ XML: ' + e.message, 'warn');
    const xmlFileInfoEl = $('#xmlFileInfo');
    const xmlStatusEl = $('#xmlStatus');
    if (xmlFileInfoEl) {
      xmlFileInfoEl.style.display = 'block';
    }
    if (xmlStatusEl) {
      xmlStatusEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
      xmlStatusEl.style.color = 'var(--danger)';
    }
    disableXmlButtons();
  }
};
// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º XML –∏–º–ø–æ—Ä—Ç–∞
function enableXmlButtons() {
  const importBtn = $('#btnDoImportXml');
  const clearBtn = $('#btnClearXml');
  if (importBtn) {
    importBtn.disabled = false;
    importBtn.style.opacity = '1';
  }
  if (clearBtn) {
    clearBtn.disabled = false;
    clearBtn.style.opacity = '1';
  }
}

function disableXmlButtons() {
  const importBtn = $('#btnDoImportXml');
  const clearBtn = $('#btnClearXml');
  if (importBtn) {
    importBtn.disabled = true;
    importBtn.style.opacity = '0.5';
  }
  if (clearBtn) {
    clearBtn.disabled = true;
    clearBtn.style.opacity = '0.5';
  }
}

function clearXmlSelection() {
  PENDING_XML_TEXT = null;
  
  const xmlFileInfoEl = $('#xmlFileInfo');
  if (xmlFileInfoEl) {
    xmlFileInfoEl.style.display = 'none';
  }
  
  // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
  const elements = ['#xmlFileName', '#xmlInfo', '#xmlStatus'];
  elements.forEach(sel => {
    const el = $(sel);
    if (el) el.textContent = '';
  });
  
  disableXmlButtons();
}


async function doImportXml(){
  if(!PENDING_XML_TEXT){ 
    toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ XML —Ñ–∞–π–ª', 'warn'); 
    return;
  }
  
  try{
    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º –Ω–æ–≤–æ–≥–æ XML
    resetBeforeImport('xml')
    const res = parseXmlTransactions(PENDING_XML_TEXT);
    
    if(!res || !res.transactions || !res.transactions.length){ 
      toast('–í XML —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏','warn'); 
      return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const xmlStatusEl = $('#xmlStatus');
    if (xmlStatusEl) {
      xmlStatusEl.textContent = `–ò–º–ø–æ—Ä—Ç ${res.transactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π...`;
      xmlStatusEl.style.color = 'var(--primary)';
    }
    
    addTransactions(res.transactions);
    if(res.currency){ 
      STATE.vault.currency = res.currency;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if(res.transactions.length > 0){
      const dates = res.transactions.map(t => t.date).sort()
      const firstDate = new Date(dates[0])
      const lastDate = new Date(dates[dates.length-1])
      PERIOD_FILTER.fromMonth = monthKey(firstDate)
      PERIOD_FILTER.toMonth = monthKey(lastDate)
      PERIOD_FILTER.singleMonth = monthKey(lastDate) // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –∫–∞–∫ –æ–¥–∏–Ω–æ—á–Ω—ã–π
    }
    
    await saveVault(); 
    render(); 
    
    toast(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${res.transactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);
    
    // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
    clearFile('bankXml');
    clearXmlSelection();
    
  } catch(err){ 
    toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ XML: ' + err.message, 'warn');
    
    const xmlStatusEl = $('#xmlStatus');
    if (xmlStatusEl) {
      xmlStatusEl.textContent = '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message;
      xmlStatusEl.style.color = 'var(--danger)';
    }
  }
}
function previewXml(xmlText){
  try{
    const {transactions,currency} = parseXmlTransactions(xmlText)
    if(!transactions || !transactions.length) {
      return {count:0}
    }
    
    const dates = transactions.map(t=>new Date(t.date))
    const firstDate = dateFmt.format(new Date(Math.min(...dates)))
    const lastDate = dateFmt.format(new Date(Math.max(...dates)))
    return {count:transactions.length, firstDate, lastDate, currency}
  } catch(e) { 
    return {count:0} 
  }
}
function parseXmlTransactions(xmlText){
  
  // –ü—Ä–∏–≤–µ–¥—ë–º –≤–æ–∑–º–æ–∂–Ω—ã–π BOM/–∫–æ–¥–∏—Ä–æ–≤–∫—É: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ UTF-16LE/BE –∏ UTF-8
  if(typeof xmlText !== 'string'){
    xmlText = String(xmlText)
  }
  // –£–¥–∞–ª—è–µ–º BOM, –µ—Å–ª–∏ –µ—Å—Ç—å
  if(xmlText.charCodeAt(0)===0xFEFF){ xmlText = xmlText.slice(1) }
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, 'application/xml');
  const parserErr = doc.querySelector('parsererror');
  
  if(parserErr) {
    throw new Error('XML parse error');
  }
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º–µ–Ω–∞: –ø—Ä–∏–≤–µ–¥—ë–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
  function tagsLower(arr){ return arr.map(s=>String(s).toLowerCase()) }
  const amountTags = tagsLower(['amount','amt','sum','value','transactionamount','creditamount','debitamount','entryamount','bookedamount','instructedamount','amount_c','amount_d','—Ü–µ–Ω–Ω–æ—Å—Ç—å','—Å—É–º–º–∞','AMOUNT_C','AMOUNT_D'])
  const dateTags = tagsLower(['date','bookingdate','valuedate','posted','postdate','tradedate','transdate','entrydate','post_date','–¥–∞—Ç–∞','POST_DATE'])
  const indicatorTags = tagsLower(['creditdebitindicator','crdr','dc','drcr','debitcredit','direction','indicator','sign','–ø—Ä–∏–∑–Ω–∞–∫','—Ç–∏–ø'])
  const descTags = tagsLower(['description','narrative','details','memo','text','remittanceinformation','purpose','name','payee','merchant','counterparty','beneficiary','payer','receiver','reference','info','note','–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ','–æ–ø–∏—Å–∞–Ω–∏–µ','TR_NAME','NAME_R','REM_I','REM_II'])
  const currencyTags = tagsLower(['currency','ccy','curr','–≤–∞–ª—é—Ç–∞'])
  const all = Array.from(doc.querySelectorAll('*'));
  const candidates = new Map();
  for(const el of all){
    const hasAmt = qAny(el, amountTags);
    const hasDate = qAny(el, dateTags);
    if(hasAmt && hasDate){
      const key = el.tagName.toLowerCase();
      candidates.set(key, (candidates.get(key)||0)+1);
    }
  }
  let txTag=null, best=0;
  for(const [k,v] of candidates){ if(v>best){best=v; txTag=k} }
  if(!txTag){ for(const k of ['transaction','entry','statementline','record','operation','row','item','movement']){ if(doc.getElementsByTagName(k).length){ txTag=k; break } } }
  // –í XML —Ç–µ–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–µ, –ø–æ—ç—Ç–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é
  const allEls = Array.from(doc.getElementsByTagName('*'))
  const nodes = txTag ? allEls.filter(n=>n.tagName.toLowerCase()===txTag) : []
  
  const txs=[]; let detectedCurrency=null;
  for(const n of nodes){
    // –í–∞—Ä–∏–∞–Ω—Ç —Å–æ —Å—Ç—Ä–æ–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ –¥–ª—è test.xml
    const directDate = (n.getElementsByTagName('POST_DATE')[0]||n.getElementsByTagName('post_date')[0])?.textContent?.trim()
    const directCredit = (n.getElementsByTagName('AMOUNT_C')[0]||n.getElementsByTagName('amount_c')[0])?.textContent?.trim()
    const directDebit = (n.getElementsByTagName('AMOUNT_D')[0]||n.getElementsByTagName('amount_d')[0])?.textContent?.trim()
    
    let dateStr = getFirstText(n, dateTags) || directDate
    const amtObj = getAmount(n, amountTags) || (directCredit?{value:directCredit,node:{tagName:'AMOUNT_C'}}: directDebit?{value:directDebit,node:{tagName:'AMOUNT_D'}}: null)
    if(!amtObj || !dateStr) { continue }
    
    let amt = parseAmountAuto(amtObj.value);
    const ind = getFirstText(n, indicatorTags);
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è AMOUNT_C –∏ AMOUNT_D  
    const creditAmt = getFirstText(n, ['creditamount', 'amount_c']);
    const debitAmt = getFirstText(n, ['debitamount', 'amount_d']);
    
    if(creditAmt && !debitAmt){ 
      amt = Math.abs(parseAmountAuto(creditAmt));
    }
    else if(debitAmt && !creditAmt){ 
      amt = -Math.abs(parseAmountAuto(debitAmt));
    }
    else if(ind){
      const s = ind.trim().toLowerCase();
      if(['cr','c','credit','–∫—Ä–µ–¥–∏—Ç'].includes(s)) amt = Math.abs(amt);
      else if(['dr','d','debit','–¥–µ–±–µ—Ç'].includes(s)) amt = -Math.abs(amt);
    }
    if(/^[‚àí‚Äì‚Äî-]/.test(String(amtObj.value).trim())) amt = -Math.abs(Math.abs(amt));
    const d = parseDateFlexible(dateStr); if(!d) continue;
    const desc = getFirstText(n, descTags) || '';
    const curr = amtObj.currency || getFirstText(n, currencyTags) || (amtObj.node && (amtObj.node.getAttribute('ccy')||amtObj.node.getAttribute('currency')||amtObj.node.getAttribute('curr')));
    if(curr && !detectedCurrency) detectedCurrency = String(curr).trim().toUpperCase();
    txs.push({id:uid(),date:d.toISOString().slice(0,10),desc:String(desc).trim(),amount:amt,category:null,source:'import'});
  }
  
  return {transactions:txs, currency:detectedCurrency};
}

// ===== –£–î–ê–õ–ï–ù–ò–ï –†–£–ß–ù–´–• –û–ü–ï–†–ê–¶–ò–ô =====
function deleteManualTx(id){
  const idx = STATE.vault.transactions.findIndex(t=>t.id===id)
  if(idx<0){ toast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','warn'); return }
  if(STATE.vault.transactions[idx].source!=='manual'){ toast('–£–¥–∞–ª—è—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏','warn'); return }
  STATE.vault.transactions.splice(idx,1)
  saveVault(); render(); toast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞')
}

// ===== –†–ê–ó–í–û–†–ê–ß–ò–í–ê–ï–ú–´–ï –ö–ê–†–¢–û–ß–ö–ò =====
function openExpanded(key){ window.UI=window.UI||{}; UI.expanded=key; renderExpanded(key) }
function closeExpanded(){ window.UI=window.UI||{}; UI.expanded=null; hideExpanded() }
function hideExpanded(){ const o=$('#dashOverlay'), m=$('#dashModal'); if(o) o.style.display='none'; if(m) m.style.display='none' }
function renderExpanded(key){
  const o=$('#dashOverlay'), m=$('#dashModal'), t=$('#dashModalTitle'), c=$('#dashModalContent')
  if(!o||!m||!t||!c) return
  o.style.display='block'; m.style.display='block';
  c.innerHTML=''
  const rs = t && t.parentElement ? t.parentElement.querySelector('.right') : null
  if(rs) rs.innerHTML=''
  const {months,byM}=monthBuckets()
  const labels = months
  if(key==='bar'){
    t.textContent='–î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º'
    c.innerHTML=`<canvas id="barBig" style="height:64vh"></canvas>`
    
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const barLabels = filteredMonths
    let barIncomes = filteredMonths.map(m=>filteredByM[m]?.income || 0)
    let barExpenses = filteredMonths.map(m=>filteredByM[m]?.expense || 0)
    if(TX_FILTER==='income'){ barExpenses = barExpenses.map(()=>0) }
    if(TX_FILTER==='expense'){ barIncomes = barIncomes.map(()=>0) }
    drawBarChart($('#barBig'), barLabels, [barIncomes, barExpenses], ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'])
  }else if(key==='line'){
    t.textContent='–ß–∏—Å—Ç—ã–π –∏—Ç–æ–≥ –ø–æ –º–µ—Å—è—Ü–∞–º'
    c.innerHTML=`<canvas id="lineBig" style="height:64vh"></canvas>`
    
    const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
    const lineLabels = filteredMonths
    const lineNets = filteredMonths.map(m=>{
      const mData = filteredByM[m]||{income:0,expense:0,net:0}
      if(TX_FILTER==='income') return mData.income||0
      if(TX_FILTER==='expense') return -(mData.expense||0)
      return mData.net||0
    })
    drawLineChart($('#lineBig'), lineLabels, lineNets)
  }else if(key==='pie'){
    t.textContent='–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤'
    if(rs){
      rs.innerHTML = '<label class="pill" style="font-weight:normal;font-size:13px">–¢–∏–ø<select id="pieModeBig" style="margin-left:6px;font-size:13px"><option value="income_expense">–î–æ—Ö–æ–¥—ã/–†–∞—Å—Ö–æ–¥—ã</option><option value="categories">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option></select></label>'
    }
    c.innerHTML=`<canvas id="pieBig" style="height:64vh"></canvas>`
    
    const modeSel=$('#pieModeBig')
    const draw=()=>{ 
      const mode = modeSel ? modeSel.value : 'income_expense'
      const {months: filteredMonths, byM: filteredByM} = filteredMonthBuckets()
      
      // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –º–µ—Å—è—Ü–∞–º –≤ —Ñ–∏–ª—å—Ç—Ä–µ
      let totalIncome = 0, totalExpense = 0, totalByCat = {}
      filteredMonths.forEach(m => {
        const monthData = filteredByM[m]
        if(monthData) {
          totalIncome += (TX_FILTER==='expense') ? 0 : (monthData.income || 0)
          totalExpense += (TX_FILTER==='income') ? 0 : (monthData.expense || 0)
        }
      })
      
      if(mode === 'categories'){
        const tx = filteredTransactions()
        tx.forEach(t=>{
          const cat=t.category||'–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
          totalByCat[cat]=(totalByCat[cat]||0)+Math.abs(t.amount||0)
        })
        const l=Object.keys(totalByCat)
        const v=l.map(k=>totalByCat[k])
        drawDonutChart($('#pieBig'), l, v) 
      }else{
        drawDonutChart($('#pieBig'), ['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'], [totalIncome, totalExpense])
      }
    }
    if(modeSel) modeSel.value = (window.UI && UI.pieCats) ? 'categories' : 'income_expense'
    draw(); 
    if(modeSel) modeSel.onchange=draw
  }else if(key==='recent'){
    const totalCount = getFilteredAndSearchedTransactions().length
    const expandLimit = totalCount // –í expand —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    t.textContent='–û–ø–µ—Ä–∞—Ü–∏–∏'
    if(rs){
      rs.innerHTML = '<div style="display:flex;gap:8px;align-items:center"><input id="searchInputBig" type="text" placeholder="–ü–æ–∏—Å–∫..." value="'+SEARCH_TEXT+'" style="width:180px;font-size:13px"></div>'
    }
    
    const updateBigTable = () => {
      const rows = getFilteredAndSearchedTransactions()
      const curr = STATE.vault.currency
      const tableContainer = c.querySelector('.table-scroll')
      
      if(tableContainer) {
        tableContainer.querySelector('tbody').innerHTML = rows.map(t=>`<tr><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${escapeHtml(t.category||'')}</td><td style="text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(t.amount)}</td><td style="width:32px;text-align:right;">${t.source==='manual'?`<button class="btn-small" data-del-tx="${t.id}">üóë</button>`:''}</td></tr>`).join('')
        // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
        $$('[data-del-tx]', tableContainer).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')); updateBigTable() } })
      }
    }
    
    const rows = getFilteredAndSearchedTransactions()
    const curr = STATE.vault.currency
    c.innerHTML = `<div class="table-scroll" style="max-height:60vh">
      <table>
        <thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style="text-align:right">–°—É–º–º–∞</th><th></th></tr></thead>
        <tbody>
          ${rows.map(t=>`<tr><td>${dateFmt.format(new Date(t.date))}</td><td>${escapeHtml(t.desc||'')}</td><td>${escapeHtml(t.category||'')}</td><td style="text-align:right;color:${t.amount>=0?'var(--ok)':'var(--danger)'}">${new Intl.NumberFormat('ru-RU',{style:'currency',currency:curr}).format(t.amount)}</td><td style="width:32px;text-align:right;">${t.source==='manual'?`<button class="btn-small" data-del-tx="${t.id}">üóë</button>`:''}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>`
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ –≤ expand —Ä–µ–∂–∏–º–µ
    const searchInputBig = $('#searchInputBig')
    
    if(searchInputBig) {
      searchInputBig.oninput = () => {
        SEARCH_TEXT = searchInputBig.value
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ —Ç–æ–∂–µ
        const normalSearchInput = $('#searchInput')
        if(normalSearchInput) normalSearchInput.value = SEARCH_TEXT
        updateBigTable()
        updateRecentOperationsTable()
      }
    }
    $$('[data-del-tx]', c).forEach(b=>{ b.onclick=()=>{ deleteManualTx(b.getAttribute('data-del-tx')) } })
  }
}

function qAny(node, tags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(tags.includes(el.tagName.toLowerCase())) return true
  }
  return false
}
function getFirstText(node, tags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(tags.includes(el.tagName.toLowerCase())){
      const txt=(el.textContent||'').trim(); if(txt) return txt
    }
  }
  return null
}
function getAmount(node, amountTags){
  const all = node.getElementsByTagName('*')
  for(const el of all){
    if(amountTags.includes(el.tagName.toLowerCase())){
      const txt=(el.textContent||'').trim(); if(!txt) continue
      const curr = el.getAttribute('ccy')||el.getAttribute('currency')||el.getAttribute('curr')
      return {value:txt,currency:curr,node:el}
    }
  }
  return null
}
function parseAmountAuto(s){
  s=String(s).replace(/\s/g,'');
  if(s.includes('.') && s.includes(',')){ const lc=Math.max(s.lastIndexOf(','),0); const ld=Math.max(s.lastIndexOf('.'),0); if(lc>ld){ s=s.replace(/\./g,'').replace(',', '.') } else { s=s.replace(/,/g,'') } }
  else if(s.includes(',') && !s.includes('.')){ s=s.replace(',','.') }
  return parseFloat(s)
}

// ===== –≠–ö–°–ü–û–†–¢ –ê–ì–†–ï–ì–ê–¢–û–í =====
function exportAggregates(){
  const {months,byM}=monthBuckets();
  const data = months.map(m=>({month:m,income:+byM[m].income.toFixed(2),expense:+byM[m].expense.toFixed(2),net:+byM[m].net.toFixed(2),count:byM[m].items.length}));
  const payload = {currency:STATE.vault.currency, generatedAt:new Date().toISOString(), data};
  download(`ofb-aggregates-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload,null,2));
}

function labelOf(f){
  return {date:'–î–∞—Ç–∞', amount:'–°—É–º–º–∞', desc:'–û–ø–∏—Å–∞–Ω–∏–µ', category:'–ö–∞—Ç–µ–≥–æ—Ä–∏—è'}[f]
}

function guessMapping(head){
  const lower=head.map(h=>String(h).toLowerCase())
  function find(...alts){for(const a of alts){const i=lower.findIndex(h=>h.includes(a)); if(i>=0) return i} return 0}
  return {
    date: find('date','–¥–∞—Ç–∞','booking','posted','operation'),
    amount: find('amount','—Å—É–º–º–∞','debit/credit','debit','credit','ammount'),
    desc: find('description','–æ–ø–∏—Å–∞–Ω–∏–µ','memo','details','note','reference'),
    category: find('category','–∫–∞—Ç–µ–≥–æ—Ä–∏—è','mcc','type')
  }
}

function rowToTx(r,map,dec,fmtSel){
  function parseAmt(s){ if(dec===',') s=s.replace(/\./g,'').replace(',','.') ; return parseFloat(String(s).replace(/\s/g,'')) }
  function parseDateFmt(s){
    if(fmtSel==='auto') return parseDateFlexible(s)
    const m = String(s).match(/(\d{1,4})\D(\d{1,2})\D(\d{1,4})/)
    if(!m) return parseDateFlexible(s)
    let Y,M,D
    if(fmtSel==='Y-M-D'){Y=+m[1];M=+m[2];D=+m[3]}
    if(fmtSel==='D.M.Y'){D=+m[1];M=+m[2];Y=+m[3]}
    if(fmtSel==='M/D/Y'){M=+m[1];D=+m[2];Y=+m[3]}
    if(fmtSel==='D/M/Y'){D=+m[1];M=+m[2];Y=+m[3]}
    const d=new Date(Y,M-1,D); return isNaN(d)?null:d
  }
  try{
    const sDate=r[map.date], sAmt=r[map.amount], sDesc=r[map.desc], sCat=r[map.category]
    const d=parseDateFmt(sDate); if(!d) return null
    const a=parseAmt(sAmt); if(!isFinite(a) || a===0) return null
    return {id:uid(),date:d.toISOString().slice(0,10),desc:String(sDesc||'').trim(),amount:a,category:String(sCat||'').trim()||null,source:'import'}
  }catch(err){return null}
}

// ===== –ì–†–ê–§–ò–ö–ò (Canvas 2D, –±–µ–∑ –ª–∏–±) =====
// chart helpers moved to assets/charts.js

function download(name, content){
  // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã)
  const saveWithPicker = async ()=>{
    if(window.showSaveFilePicker){
      try{
        const handle = await showSaveFilePicker({
          suggestedName: name,
          types: [{ description:'JSON', accept:{'application/json':['.json']} }]
        })
        const writable = await handle.createWritable()
        await writable.write(new Blob([content],{type:'application/json'}))
        await writable.close()
        toast('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω')
        return true
      }catch(e){ /* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –æ—Ç–º–µ–Ω–∏—Ç—å */ }
    }
    return false
  }
  ;(async()=>{
    const ok = await saveWithPicker()
    if(ok) return
    // –§–æ–ª–±—ç–∫ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –ø–∞–ø–∫—É –∑–∞–≥—Ä—É–∑–æ–∫
    const a=document.createElement('a')
    a.href=URL.createObjectURL(new Blob([content],{type:'application/json'}))
    a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000)
    toast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –≤ –ø–∞–ø–∫—É Data')
  })()
}

async function saveChartsPng(){
  const files=[]
  for(const id of ['bar','line','pie']){
    const c = $('#'+id)
    const blob = await new Promise(res=>c.toBlob(res))
    files.push({name:`${id}-${new Date().toISOString().slice(0,10)}.png`, blob})
  }
  for(const f of files){
    const a=document.createElement('a'); a.href=URL.createObjectURL(f.blob); a.download=f.name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800)
  }
  toast('–ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (PNG)')
}

// ===== –ò–ù–ò–¶ =====
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–º—É –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
initTheme()

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ header
$('#themeToggle').onclick = toggleTheme
$('#helpToggle').onclick = toggleHelp
$('#btnClearStorage').onclick = () => {
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å localStorage (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã)?')) {
    localStorage.removeItem(LS_KEY)
    localStorage.removeItem('finboard_theme')
    STATE = {unlocked:true, pass:null, vault:emptyVault()}
    window.UI = {}
    render()
    toast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã')
  }
}

render()

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è XML –∏–º–ø–æ—Ä—Ç–∞
disableXmlButtons()

// –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—â–∏–∫ –≥—Ä–∞—Ñ–∏–∫–æ–≤
let ro=new ResizeObserver(()=>{ bindMain() })
ro.observe(document.body)

function clearFile(id){ const el=$('#'+id); if(!el) return; try{ el.value=''; }catch{ /* ignore */ } }

// helpHTML –≤—ã–Ω–µ—Å–µ–Ω –≤ assets/help.js

</script>
</body>
</html>



